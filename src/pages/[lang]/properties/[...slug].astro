---
export const prerender = false;

import { INDEXABLE_CITIES, INDEXABLE_AREAS, INDEXABLE_TYPES } from "@/config/seoSlugs";
import { normalizeCity } from "@/utils/normalizeCity";
import { normalizeArea } from "@/utils/normalizeArea";
import { DEFAULT_LANG, isSupportedLang } from "@/i18n/languages";

const { slug = [], lang = DEFAULT_LANG } = Astro.params;

if (!isSupportedLang(lang)) {
  return Astro.redirect(`/${DEFAULT_LANG}/properties/`, 302);
}

// Máximo permitido: /city o /city/zone o /city/type
if (slug.length === 0 || slug.length > 2) {
  return Astro.redirect(`/${lang}/properties/`, 301);
}

const citySlug = slug[0];
if (!INDEXABLE_CITIES.includes(citySlug)) {
  return Astro.redirect(`/${lang}/properties/`, 301);
}

let city = normalizeCity(citySlug);
let area: string | null = null;
let type: string | null = null;

// CASO 1: /city
if (slug.length === 1) {
  // OK
}

// CASO 2: /city/second
if (slug.length === 2) {
  const second = slug[1];

  // ¿Es tipo?
  if (INDEXABLE_TYPES.includes(second)) {
    type = second;
  }

  // ¿Es zona?
  if (INDEXABLE_AREAS[citySlug]?.includes(second)) {
    area = normalizeArea(second);
  }

  // Si no es ni tipo ni zona → fuera
  if (!type && !area) {
    return Astro.redirect(`/${lang}/properties/${citySlug}/`, 301);
  }
}

// ⚠️ Prohibido: city + area + type
// (ya lo evitamos porque solo aceptamos 2 segmentos)

// Construimos URL interna limpia
const url = new URL(Astro.request.url);
url.pathname = `/${lang}/properties/`;

url.searchParams.set("city", city);
if (area) url.searchParams.set("area", area);
if (type) url.searchParams.set("type", type);

// Eliminamos basura técnica
url.searchParams.delete("sort");
url.searchParams.delete("page");

return Astro.redirect(url.pathname + url.search, 307);
---
