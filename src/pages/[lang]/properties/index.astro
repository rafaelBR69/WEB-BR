---
export const prerender = false;

import BaseLayout from "@/layouts/BaseLayout.astro";
import properties from "@/data/properties";
import PropertyCard from "@/components/PropertyCard.astro";

import { normalizePropertyCard } from "@/utils/normalizePropertyCard";
import { normalizePropertyList } from "@/utils/normalizePropertyList";
import { buildFilters } from "@/utils/buildFilters";
import { applyFilters } from "@/utils/applyFilters";
import { normalizeCity } from "@/utils/normalizeCity";
import { normalizeArea } from "@/utils/normalizeArea";
import { displayLocation, formatPropertyType } from "@/utils/presentation";
import { TYPES, MARKET_TYPE } from "@/data/properties/taxonomies";
import { DEFAULT_LANG, isSupportedLang, SUPPORTED_LANGS } from "@/i18n/languages";
import "@/styles/pages/properties.css";

const langParam = Astro.params.lang ?? DEFAULT_LANG;
if (!isSupportedLang(langParam)) {
  return Astro.redirect(`/${DEFAULT_LANG}/properties/`, 302);
}

const lang = langParam;

/* =========================
   FILTROS ACTIVOS (QUERY PARAMS)
========================= */
const { searchParams } = Astro.url;

const getMultiParam = (key) => {
  const values = searchParams.getAll(key)
    .map((v) => String(v).trim())
    .filter(Boolean);
  return values.length ? values : null;
};

const toggleMulti = (current, value) => {
  const next = new Set(current || []);
  if (next.has(value)) {
    next.delete(value);
  } else {
    next.add(value);
  }
  return Array.from(next);
};

const normalizeTypeParam = (value) => {
  if (!value) return null;
  const normalized = String(value).toLowerCase().trim();
  if (TYPES[normalized]) return normalized;

  for (const [key, def] of Object.entries(TYPES)) {
    if (def.label?.[lang]?.toLowerCase() === normalized) return key;
    if (def.label?.es?.toLowerCase() === normalized) return key;
  }

  return normalized;
};

const activeFilters = {
  city: searchParams.get("city")
    ? normalizeCity(searchParams.get("city"))
    : null,

  area: searchParams.get("area")
    ? normalizeArea(searchParams.get("area"))
    : null,

  type: getMultiParam("type")
    ? getMultiParam("type").map((v) => normalizeTypeParam(v))
    : null,
  market: searchParams.get("market") || null,

  bedrooms: getMultiParam("bedrooms")
    ? getMultiParam("bedrooms").map((v) => Number(v)).filter((v) => !Number.isNaN(v))
    : null,

  floor: getMultiParam("floor")
    ? getMultiParam("floor").map((v) => String(v).trim()).filter(Boolean)
    : null,

  priceMin: searchParams.get("priceMin")
    ? Number(searchParams.get("priceMin"))
    : null,

  priceMax: searchParams.get("priceMax")
    ? Number(searchParams.get("priceMax"))
    : null,
  search: searchParams.get("q")
    ? String(searchParams.get("q")).trim()
    : null,
};

const hasTechnicalFilters =
  searchParams.has("sort") ||
  searchParams.has("page");

/* =========================
   LISTADO NORMALIZADO
========================= */
const cards = properties
  .map((p) => normalizePropertyCard(p, lang))
  .filter(Boolean)
  .filter((p) => p.visible);

/* =========================
   APLICAR FILTROS
========================= */
const filteredCards = applyFilters(cards, activeFilters);

/* =========================
   ORDENACI칍N
========================= */
const sort = searchParams.get("sort");
const sortApplied = sort ?? "priority";

const sortedCards = [...filteredCards].sort((a, b) => {
  if (sortApplied === "price_desc") return b.price - a.price;
  if (sortApplied === "price_asc") return a.price - b.price;
  const byPriority = (b.priority ?? 0) - (a.priority ?? 0);
  if (byPriority !== 0) return byPriority;
  return (b.price ?? 0) - (a.price ?? 0);
});

/* =========================
   FILTROS DISPONIBLES (CONTEXTUALES)
========================= */
const filters = buildFilters(cards) as {
  cities: string[];
  areas: Record<string, string[]>;
  types: string[];
  markets: string[];
  bedrooms: number[];
  floors: string[];
  price: { min: number; max: number };
};

const formatFloorLabel = (floorValue) => floorValue;

/* =========================
   SEO
========================= */
const listSeo = normalizePropertyList({
  lang,
  city: activeFilters.city,
  area: activeFilters.area,
  type: activeFilters.type,
  market: activeFilters.market,
  province: "Costa del Sol",
  hasTechnicalFilters,
});

/* =========================
   URL BUILDER
========================= */
function buildUrl(overrides = {}) {
  const params = new URLSearchParams();

  const merged = {
    city: activeFilters.city,
    area: activeFilters.area,
    type: activeFilters.type,
    market: activeFilters.market,
    bedrooms: activeFilters.bedrooms,
    floor: activeFilters.floor,
    priceMin: activeFilters.priceMin,
    priceMax: activeFilters.priceMax,
    q: activeFilters.search,
    sort,
    ...overrides,
  };

  Object.entries(merged).forEach(([key, value]) => {
    if (value === null || value === undefined) return;
    if (Array.isArray(value)) {
      value.filter((v) => v !== null && v !== undefined).forEach((v) => {
        params.append(key, String(v));
      });
      return;
    }
    params.set(key, String(value));
  });

  const qs = params.toString();
  return qs ? `?${qs}` : `/${lang}/properties/`;
}
const isFiltered = !!(
  activeFilters.city ||
  activeFilters.area ||
  (activeFilters.type && activeFilters.type.length) ||
  (activeFilters.bedrooms && activeFilters.bedrooms.length) ||
  (activeFilters.floor && activeFilters.floor.length) ||
  activeFilters.market ||
  activeFilters.priceMin ||
  activeFilters.priceMax ||
  activeFilters.search
);
// formatFloorLabel defined above (identity)

const formatMarketLabel = (value) => {
  const def = MARKET_TYPE?.[value];
  return def?.label?.[lang] ?? value;
};
---

<BaseLayout
  title={listSeo.title}
  description={listSeo.description}
  noindex={listSeo.noindex}
  lang={lang}
  availableLangs={SUPPORTED_LANGS}
>
  <div class={`properties-page ${isFiltered ? 'is-filtered' : ''}`}>
    
    <!-- HEADER DE P츼GINA -->
    <header class="properties-header">
      <div class="header-content">
        <h1>{listSeo.title}</h1>
        { !isFiltered && (
          <p class="subtitle">
            Encuentra tu propiedad ideal en {displayLocation(activeFilters.city) || "la Costa del Sol"}.
          </p>
        )}
      </div>
    </header>


        {!activeFilters.area && activeFilters.city && (
          <section class="city-exploration-section">
            <div class="exploration-content">
              <div class="exploration-header">
                <span class="exploration-label">Selecci칩n Exclusiva</span>
                <h2>{displayLocation(activeFilters.city)}</h2>
                <div class="exploration-divider"></div>
                <p>
                  {`Explore las residencias m치s prestigiosas en ${displayLocation(activeFilters.city)}. Seleccionamos cuidadosamente propiedades que definen el estilo de vida mediterr치neo.`}
                </p>
              </div>
              
              <div class="exploration-links">
                {filters.areas[activeFilters.city]?.length > 0 && (
                  <div class="link-group">
                    <h4>Zonas destacadas</h4>
                    <div class="link-list">
                      {filters.areas[activeFilters.city].map((area: string) => (
                        <a href={buildUrl({ area })} class="text-link">
                          {displayLocation(area)}
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                <div class="link-group">
                  <h4>Propiedades en {displayLocation(activeFilters.city)}</h4>
                  <div class="link-list">
                    {filters.types.map((type: string) => (
                      <a href={buildUrl({ type })} class="text-link">
                        {formatPropertyType(type, lang)}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </section>
        )}

    <div class="properties-layout">
      
      <!-- SIDEBAR FILTROS -->
      <aside class="properties-sidebar">
        <div class="filters-sticky">
           <section class="filters-panel">
            <details class="filters-disclosure" id="filtersDisclosure" open>
              <summary class="filters-summary" aria-label="Abrir filtros de propiedades" aria-controls="filtersBody">
                <span>Filtrar propiedades</span>
              </summary>
              <div class="filters-body" id="filtersBody">
                <div class="filters-header desktop-only">
                  <h2>Filtrar</h2>
                  {(activeFilters.city || activeFilters.area || (activeFilters.type && activeFilters.type.length) || (activeFilters.bedrooms && activeFilters.bedrooms.length) || (activeFilters.floor && activeFilters.floor.length) || activeFilters.market || activeFilters.search) && (
                    <a href={`/${lang}/properties/`} class="reset-all">Limpiar todo</a>
                  )}
                </div>

            {filters.cities.length > 0 && (
              <div class="filter-group">
                <h3>Ubicaci칩n</h3>
                <ul class="filter-list vertical">
                  {filters.cities.map((city: string) => (
                    <li class={city === activeFilters.city ? "active" : ""}>
                      <a href={buildUrl({ city: city === activeFilters.city ? null : city, area: null })}>
                        <span class="check-icon"></span>
                        {displayLocation(city)}
                        {city === activeFilters.city && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {activeFilters.city && filters.areas[activeFilters.city]?.length > 0 && (
              <div class="filter-group">
                <h3>Zonas en {displayLocation(activeFilters.city)}</h3>
                <ul class="filter-list vertical">
                  {filters.areas[activeFilters.city].map((area: string) => (
                    <li class={area === activeFilters.area ? "active" : ""}>
                      <a href={buildUrl({ area: area === activeFilters.area ? null : area })}>
                         <span class="check-icon"></span>
                        {displayLocation(area)}
                        {area === activeFilters.area && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {(filters.types.length > 1 || (activeFilters.type && activeFilters.type.length)) && (
              <div class="filter-group">
                <h3>Tipo de Propiedad</h3>
                <ul class="filter-list vertical">
                  {filters.types.map((type: string) => (
                    <li class={activeFilters.type?.includes(type) ? "active" : ""}>
                      <a href={buildUrl({ type: toggleMulti(activeFilters.type, type) })}>
                         <span class="check-icon"></span>
                        {formatPropertyType(type, lang)}
                        {activeFilters.type?.includes(type) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.markets.length > 0 && (
              <div class="filter-group">
                <h3>Estado</h3>
                <ul class="filter-list vertical">
                  {filters.markets.map((market: string) => (
                    <li class={market === activeFilters.market ? "active" : ""}>
                      <a href={buildUrl({ market: market === activeFilters.market ? null : market })}>
                        <span class="check-icon"></span>
                        {formatMarketLabel(market)}
                        {market === activeFilters.market && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.bedrooms.length > 0 && (
              <div class="filter-group">
                <h3>Dormitorios</h3>
                <ul class="filter-list vertical">
                  {filters.bedrooms.map((bedrooms: number) => (
                    <li class={activeFilters.bedrooms?.includes(bedrooms) ? "active" : ""}>
                      <a href={buildUrl({ bedrooms: toggleMulti(activeFilters.bedrooms, bedrooms) })}>
                         <span class="check-icon"></span>
                        {bedrooms} dormitorios
                        {activeFilters.bedrooms?.includes(bedrooms) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.floors.length > 0 && (
              <div class="filter-group">
                <h3>Planta</h3>
                <ul class="filter-list vertical">
                  {filters.floors.map((floor: string) => (
                    <li class={activeFilters.floor?.includes(floor) ? "active" : ""}>
                      <a href={buildUrl({ floor: toggleMulti(activeFilters.floor, floor) })}>
                        <span class="check-icon"></span>
                        {formatFloorLabel(floor)}
                        {activeFilters.floor?.includes(floor) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
            
              </div>
            </details>
          </section>
        </div>
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="properties-content">
        <script is:inline>
          const disclosure = document.getElementById('filtersDisclosure');
          const mql = window.matchMedia('(min-width: 1024px)');

          const syncFiltersDisclosure = () => {
            if (!disclosure) return;
            if (mql.matches) {
              disclosure.setAttribute('open', '');
            } else {
              disclosure.removeAttribute('open');
            }
          };

          syncFiltersDisclosure();
          mql.addEventListener('change', syncFiltersDisclosure);
        </script>
        
        <!-- BARRA SUPERIOR (Resultados + Ordenar) -->
        <div class="content-header">
          <div class="results-summary">
            <p class="results-count">
              <strong>{sortedCards.length}</strong> propiedades encontradas
            </p>
            {activeFilters.search && (
              <p class="results-query">
                Resultados para "<span>{activeFilters.search}</span>"
              </p>
            )}
          </div>
          
          <div class="sort-dropdown">
             <span>Ordenar por:</span>
             <div class="sort-options">
                <a href={buildUrl({ sort: "priority" })} class={sort === 'priority' ? 'active' : ''}>Relevancia</a>
                <a href={buildUrl({ sort: "price_asc" })} class={sort === 'price_asc' ? 'active' : ''}>Precio: Menor a Mayor</a>
                <a href={buildUrl({ sort: "price_desc" })} class={sort === 'price_desc' ? 'active' : ''}>Precio: Mayor a Menor</a>
             </div>
          </div>
        </div>

        <form class="search-bar" method="get" action={`/${lang}/properties/`}>
          <input
            type="search"
            name="q"
            placeholder="Buscar por zona, ciudad o palabra clave"
            value={activeFilters.search ?? ""}
            aria-label="Buscar propiedades"
          />
          {activeFilters.city && (
            <input type="hidden" name="city" value={activeFilters.city} />
          )}
          {activeFilters.area && (
            <input type="hidden" name="area" value={activeFilters.area} />
          )}
          {activeFilters.type?.map((type: string) => (
            <input type="hidden" name="type" value={type} />
          ))}
          {activeFilters.bedrooms?.map((bedroom: number) => (
            <input type="hidden" name="bedrooms" value={bedroom} />
          ))}
          {activeFilters.floor?.map((floor: string) => (
            <input type="hidden" name="floor" value={floor} />
          ))}
          {activeFilters.market && (
            <input type="hidden" name="market" value={activeFilters.market} />
          )}
          {typeof activeFilters.priceMin === "number" && (
            <input type="hidden" name="priceMin" value={activeFilters.priceMin} />
          )}
          {typeof activeFilters.priceMax === "number" && (
            <input type="hidden" name="priceMax" value={activeFilters.priceMax} />
          )}
          {sort && <input type="hidden" name="sort" value={sort} />}
          <button type="submit">Buscar</button>
        </form>

        {sortedCards.length === 0 ? (
          <div class="empty-state">
            <div class="empty-icon">游댌</div>
            <h3>No encontramos propiedades exactas</h3>
            <p>Prueba a ajustar tus filtros o ampliar la zona de b칰squeda.</p>
            <a href={`/${lang}/properties/`} class="btn btn-primary">Ver todas las propiedades</a>
          </div>
        ) : (
          <>
            <section class="properties-grid">
              {sortedCards.map((data) => (
                <PropertyCard data={data} lang={lang} />
              ))}
            </section>
          </>
        )}

      </main>
    </div>

    <!-- CTA FOOTER (CENTRADOR) -->
    <div class="list-footer-cta">
      <h3>쯅o encuentras lo que buscas?</h3>
      <p>
        {activeFilters.city
          ? `쮹uscas propiedades en ${displayLocation(activeFilters.city)}? Te asesoramos sin compromiso.`
          : "쮹uscas propiedades en la Costa del Sol? Te asesoramos sin compromiso."}
      </p>
      <a href={`/${lang}/contacto`} class="btn btn-outline">Cont치ctanos</a>
    </div>

  </div>
</BaseLayout>

<script is:inline>
  const shouldHandleLink = (link) => {
    if (!link) return false;
    if (link.target && link.target !== "_self") return false;
    if (link.hasAttribute("download")) return false;
    const href = link.getAttribute("href");
    if (!href || href.startsWith("#")) return false;
    if (link.dataset.noAjax === "true") return false;
    if (href.startsWith("?")) return true;
    return href.includes("/properties");
  };

  const resolveHref = (href) => {
    if (href.startsWith("?")) {
      return `${window.location.pathname}${href}`;
    }
    return href;
  };

  const handleNavigation = async (href) => {
    const targetHref = resolveHref(href);
    const response = await fetch(targetHref, { headers: { "X-Requested-With": "fetch" } });
    if (!response.ok) {
      window.location.href = targetHref;
      return;
    }
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const nextPage = doc.querySelector(".properties-page");
    const currentPage = document.querySelector(".properties-page");
    const nextLayout = doc.querySelector(".properties-layout");
    const currentLayout = document.querySelector(".properties-layout");
    const nextHeader = doc.querySelector(".properties-header");
    const currentHeader = document.querySelector(".properties-header");

    if (nextPage && currentPage) {
      currentPage.className = nextPage.className;
    }
    if (nextHeader && currentHeader) {
      currentHeader.innerHTML = nextHeader.innerHTML;
    }
    if (nextLayout && currentLayout) {
      currentLayout.innerHTML = nextLayout.innerHTML;
    }

    document.title = doc.title;
    history.pushState({}, "", targetHref);

    // Keep filters open on desktop after updates
    const disclosure = document.getElementById("filtersDisclosure");
    const mql = window.matchMedia("(min-width: 1024px)");
    if (disclosure) {
      if (mql.matches) {
        disclosure.setAttribute("open", "");
      } else {
        disclosure.removeAttribute("open");
      }
    }
  };

  document.addEventListener("click", (event) => {
    const link = event.target.closest("a");
    if (!shouldHandleLink(link)) return;
    if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
    event.preventDefault();
    handleNavigation(link.getAttribute("href"));
  });

  window.addEventListener("popstate", () => {
    handleNavigation(window.location.href);
  });
</script>

