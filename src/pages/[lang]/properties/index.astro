---
export const prerender = false;

import BaseLayout from "@/layouts/BaseLayout.astro";
import fallbackProperties from "@/data/properties";
import PropertyCard from "@/components/PropertyCard.astro";
import { getPublicPropertiesWithFallback } from "@/utils/publicPropertiesSource";

import { normalizePropertyCard } from "@/utils/normalizePropertyCard";
import { normalizePropertyList } from "@/utils/normalizePropertyList";
import { buildFilters } from "@/utils/buildFilters";
import { applyFilters } from "@/utils/applyFilters";
import { normalizeCity } from "@/utils/normalizeCity";
import { normalizeArea } from "@/utils/normalizeArea";
import { isVillaFloorLabel, normalizeFloorFilterLabel } from "@/utils/floorFilter";
import { displayLocation, formatPropertyType } from "@/utils/presentation";
import { TYPES, MARKET_TYPE } from "@/data/properties/taxonomies";
import { DEFAULT_LANG, isSupportedLang, SUPPORTED_LANGS } from "@/i18n/languages";
import "@/styles/pages/properties.css";

const langParam = Astro.params.lang ?? DEFAULT_LANG;
if (!isSupportedLang(langParam)) {
  return Astro.redirect(`/${DEFAULT_LANG}/properties/`, 302);
}

const lang = langParam;
const { properties } = await getPublicPropertiesWithFallback({
  fallbackProperties,
});

const copyByLang = {
  es: {
    headerSubtitle: "Encuentra tu propiedad ideal en {location}.",
    defaultLocation: "la Costa del Sol",
    exclusiveSelection: "Seleccion exclusiva",
    explorationIntro:
      "Explore las residencias mas prestigiosas en {city}. Seleccionamos cuidadosamente propiedades que definen el estilo de vida mediterraneo.",
    highlightedAreas: "Zonas destacadas",
    propertiesIn: "Propiedades en {city}",
    openFiltersAria: "Abrir filtros de propiedades",
    filterProperties: "Filtrar propiedades",
    filter: "Filtrar",
    clearAll: "Limpiar todo",
    location: "Ubicacion",
    areasIn: "Zonas en {city}",
    propertyType: "Tipo de propiedad",
    status: "Estado",
    bedrooms: "Dormitorios",
    bedroomsSuffix: "dormitorios",
    floor: "Planta",
    propertiesFound: "propiedades encontradas",
    resultsFor: "Resultados para",
    sortBy: "Ordenar por:",
    relevance: "Relevancia",
    priceAsc: "Precio: menor a mayor",
    priceDesc: "Precio: mayor a menor",
    searchPlaceholder: "Buscar por zona, ciudad o palabra clave",
    searchAria: "Buscar propiedades",
    search: "Buscar",
    emptyTitle: "No encontramos propiedades exactas",
    emptyText: "Prueba a ajustar tus filtros o ampliar la zona de busqueda.",
    viewAllProperties: "Ver todas las propiedades",
    footerTitle: "No encuentras lo que buscas?",
    footerCityPrompt:
      "Buscas propiedades en {city}? Te asesoramos sin compromiso.",
    footerDefaultPrompt:
      "Buscas propiedades en la Costa del Sol? Te asesoramos sin compromiso.",
    contactUs: "Contactanos",
  },
  en: {
    headerSubtitle: "Find your ideal property in {location}.",
    defaultLocation: "Costa del Sol",
    exclusiveSelection: "Exclusive selection",
    explorationIntro:
      "Explore the most prestigious residences in {city}. We carefully select properties that define the Mediterranean lifestyle.",
    highlightedAreas: "Top areas",
    propertiesIn: "Properties in {city}",
    openFiltersAria: "Open property filters",
    filterProperties: "Filter properties",
    filter: "Filter",
    clearAll: "Clear all",
    location: "Location",
    areasIn: "Areas in {city}",
    propertyType: "Property type",
    status: "Status",
    bedrooms: "Bedrooms",
    bedroomsSuffix: "bedrooms",
    floor: "Floor",
    propertiesFound: "properties found",
    resultsFor: "Results for",
    sortBy: "Sort by:",
    relevance: "Relevance",
    priceAsc: "Price: low to high",
    priceDesc: "Price: high to low",
    searchPlaceholder: "Search by area, city or keyword",
    searchAria: "Search properties",
    search: "Search",
    emptyTitle: "No exact properties found",
    emptyText: "Try adjusting your filters or widening your search area.",
    viewAllProperties: "View all properties",
    footerTitle: "Did not find what you need?",
    footerCityPrompt:
      "Looking for properties in {city}? We can advise you with no obligation.",
    footerDefaultPrompt:
      "Looking for properties on the Costa del Sol? We can advise you with no obligation.",
    contactUs: "Contact us",
  },
  de: {
    headerSubtitle: "Finden Sie Ihre ideale Immobilie in {location}.",
    defaultLocation: "der Costa del Sol",
    exclusiveSelection: "Exklusive Auswahl",
    explorationIntro:
      "Entdecken Sie die prestigetraechtigsten Immobilien in {city}. Wir waehlen Objekte aus, die den mediterranen Lebensstil definieren.",
    highlightedAreas: "Top-Gebiete",
    propertiesIn: "Immobilien in {city}",
    openFiltersAria: "Immobilienfilter oeffnen",
    filterProperties: "Immobilien filtern",
    filter: "Filtern",
    clearAll: "Alles zuruecksetzen",
    location: "Lage",
    areasIn: "Gebiete in {city}",
    propertyType: "Immobilientyp",
    status: "Status",
    bedrooms: "Schlafzimmer",
    bedroomsSuffix: "schlafzimmer",
    floor: "Etage",
    propertiesFound: "Immobilien gefunden",
    resultsFor: "Ergebnisse fuer",
    sortBy: "Sortieren nach:",
    relevance: "Relevanz",
    priceAsc: "Preis: niedrig bis hoch",
    priceDesc: "Preis: hoch bis niedrig",
    searchPlaceholder: "Nach Gebiet, Stadt oder Stichwort suchen",
    searchAria: "Immobilien suchen",
    search: "Suchen",
    emptyTitle: "Keine passenden Immobilien gefunden",
    emptyText: "Passen Sie Ihre Filter an oder erweitern Sie den Suchbereich.",
    viewAllProperties: "Alle Immobilien anzeigen",
    footerTitle: "Nicht gefunden, was Sie suchen?",
    footerCityPrompt:
      "Suchen Sie Immobilien in {city}? Wir beraten Sie unverbindlich.",
    footerDefaultPrompt:
      "Suchen Sie Immobilien an der Costa del Sol? Wir beraten Sie unverbindlich.",
    contactUs: "Kontakt",
  },
  fr: {
    headerSubtitle: "Trouvez votre bien ideal a {location}.",
    defaultLocation: "la Costa del Sol",
    exclusiveSelection: "Selection exclusive",
    explorationIntro:
      "Explorez les residences les plus prestigieuses a {city}. Nous selectionnons avec soin des biens qui definissent le style de vie mediterraneen.",
    highlightedAreas: "Zones vedettes",
    propertiesIn: "Proprietes a {city}",
    openFiltersAria: "Ouvrir les filtres des proprietes",
    filterProperties: "Filtrer les proprietes",
    filter: "Filtrer",
    clearAll: "Tout effacer",
    location: "Localisation",
    areasIn: "Zones a {city}",
    propertyType: "Type de propriete",
    status: "Statut",
    bedrooms: "Chambres",
    bedroomsSuffix: "chambres",
    floor: "Etage",
    propertiesFound: "proprietes trouvees",
    resultsFor: "Resultats pour",
    sortBy: "Trier par :",
    relevance: "Pertinence",
    priceAsc: "Prix : croissant",
    priceDesc: "Prix : decroissant",
    searchPlaceholder: "Rechercher par zone, ville ou mot-cle",
    searchAria: "Rechercher des proprietes",
    search: "Rechercher",
    emptyTitle: "Aucune propriete exacte trouvee",
    emptyText: "Essayez d ajuster vos filtres ou d elargir la zone de recherche.",
    viewAllProperties: "Voir toutes les proprietes",
    footerTitle: "Vous ne trouvez pas ce que vous cherchez ?",
    footerCityPrompt:
      "Vous cherchez des proprietes a {city} ? Nous vous conseillons sans engagement.",
    footerDefaultPrompt:
      "Vous cherchez des proprietes sur la Costa del Sol ? Nous vous conseillons sans engagement.",
    contactUs: "Contactez-nous",
  },
  it: {
    headerSubtitle: "Trova la tua proprieta ideale a {location}.",
    defaultLocation: "Costa del Sol",
    exclusiveSelection: "Selezione esclusiva",
    explorationIntro:
      "Esplora le residenze piu prestigiose a {city}. Selezioniamo con cura proprieta che definiscono lo stile di vita mediterraneo.",
    highlightedAreas: "Zone in evidenza",
    propertiesIn: "Proprieta a {city}",
    openFiltersAria: "Apri i filtri proprieta",
    filterProperties: "Filtra proprieta",
    filter: "Filtra",
    clearAll: "Cancella tutto",
    location: "Posizione",
    areasIn: "Zone a {city}",
    propertyType: "Tipo di proprieta",
    status: "Stato",
    bedrooms: "Camere",
    bedroomsSuffix: "camere",
    floor: "Piano",
    propertiesFound: "proprieta trovate",
    resultsFor: "Risultati per",
    sortBy: "Ordina per:",
    relevance: "Rilevanza",
    priceAsc: "Prezzo: dal minore al maggiore",
    priceDesc: "Prezzo: dal maggiore al minore",
    searchPlaceholder: "Cerca per zona, citta o parola chiave",
    searchAria: "Cerca proprieta",
    search: "Cerca",
    emptyTitle: "Nessuna proprieta esatta trovata",
    emptyText: "Prova ad adattare i filtri o ad ampliare l area di ricerca.",
    viewAllProperties: "Vedi tutte le proprieta",
    footerTitle: "Non trovi quello che cerchi?",
    footerCityPrompt:
      "Cerchi proprieta a {city}? Ti aiutiamo senza impegno.",
    footerDefaultPrompt:
      "Cerchi proprieta in Costa del Sol? Ti aiutiamo senza impegno.",
    contactUs: "Contattaci",
  },
  nl: {
    headerSubtitle: "Vind jouw ideale woning in {location}.",
    defaultLocation: "de Costa del Sol",
    exclusiveSelection: "Exclusieve selectie",
    explorationIntro:
      "Ontdek de meest prestigieuze woningen in {city}. Wij selecteren zorgvuldig woningen die de mediterrane levensstijl belichamen.",
    highlightedAreas: "Uitgelichte zones",
    propertiesIn: "Woningen in {city}",
    openFiltersAria: "Woningfilters openen",
    filterProperties: "Woningen filteren",
    filter: "Filteren",
    clearAll: "Alles wissen",
    location: "Locatie",
    areasIn: "Zones in {city}",
    propertyType: "Woningtype",
    status: "Status",
    bedrooms: "Slaapkamers",
    bedroomsSuffix: "slaapkamers",
    floor: "Verdieping",
    propertiesFound: "woningen gevonden",
    resultsFor: "Resultaten voor",
    sortBy: "Sorteren op:",
    relevance: "Relevantie",
    priceAsc: "Prijs: laag naar hoog",
    priceDesc: "Prijs: hoog naar laag",
    searchPlaceholder: "Zoek op zone, stad of trefwoord",
    searchAria: "Zoek woningen",
    search: "Zoeken",
    emptyTitle: "Geen exacte woningen gevonden",
    emptyText: "Pas je filters aan of vergroot het zoekgebied.",
    viewAllProperties: "Bekijk alle woningen",
    footerTitle: "Niet gevonden wat je zoekt?",
    footerCityPrompt:
      "Zoek je woningen in {city}? Wij adviseren je vrijblijvend.",
    footerDefaultPrompt:
      "Zoek je woningen aan de Costa del Sol? Wij adviseren je vrijblijvend.",
    contactUs: "Neem contact op",
  },
};

const t = copyByLang[lang] ?? copyByLang.es;

const renderText = (
  template,
  values: Record<string, string | number | null | undefined> = {}
) =>
  String(template).replace(/\{(\w+)\}/g, (_, key) =>
    String(values[key] ?? "")
  );

/* =========================
   FILTROS ACTIVOS (QUERY PARAMS)
========================= */
const { searchParams } = Astro.url;

const getMultiParam = (key) => {
  const values = searchParams.getAll(key)
    .map((v) => String(v).trim())
    .filter(Boolean);
  return values.length ? values : null;
};

const toggleMulti = (current, value) => {
  const next = new Set(current || []);
  if (next.has(value)) {
    next.delete(value);
  } else {
    next.add(value);
  }
  return Array.from(next);
};

const normalizeTypeParam = (value) => {
  if (!value) return null;
  const normalized = String(value).toLowerCase().trim();
  if (TYPES[normalized]) return normalized;

  for (const [key, def] of Object.entries(TYPES)) {
    if (def.label?.[lang]?.toLowerCase() === normalized) return key;
    if (def.label?.es?.toLowerCase() === normalized) return key;
  }

  return normalized;
};

const activeFilters = {
  city: searchParams.get("city")
    ? normalizeCity(searchParams.get("city"))
    : null,

  area: searchParams.get("area")
    ? normalizeArea(searchParams.get("area"))
    : null,

  type: getMultiParam("type")
    ? getMultiParam("type").map((v) => normalizeTypeParam(v))
    : null,
  market: searchParams.get("market") || null,

  bedrooms: getMultiParam("bedrooms")
    ? getMultiParam("bedrooms").map((v) => Number(v)).filter((v) => !Number.isNaN(v))
    : null,

  floor: getMultiParam("floor")
    ? [...new Set(
        getMultiParam("floor")
          .map((v) => normalizeFloorFilterLabel(v))
          .filter((v): v is string => typeof v === "string" && !isVillaFloorLabel(v))
      )]
    : null,

  priceMin: searchParams.get("priceMin")
    ? Number(searchParams.get("priceMin"))
    : null,

  priceMax: searchParams.get("priceMax")
    ? Number(searchParams.get("priceMax"))
    : null,
  search: searchParams.get("q")
    ? String(searchParams.get("q")).trim()
    : null,
  ref: searchParams.get("ref")
    ? String(searchParams.get("ref")).trim()
    : null,
};

const hasTechnicalFilters =
  searchParams.has("sort") ||
  searchParams.has("page");

/* =========================
   LISTADO NORMALIZADO
========================= */
const cards = properties
  .map((p) => normalizePropertyCard(p, lang))
  .filter(Boolean)
  .filter((p) => p.visible);

/* =========================
   APLICAR FILTROS
========================= */
const filteredCards = applyFilters(cards, activeFilters);

/* =========================
   ORDENACIÃ“N
========================= */
const sort = searchParams.get("sort");
const sortApplied = sort ?? "priority";

const sortedCards = [...filteredCards].sort((a, b) => {
  if (sortApplied === "price_desc") return b.price - a.price;
  if (sortApplied === "price_asc") return a.price - b.price;
  const byPriority = (b.priority ?? 0) - (a.priority ?? 0);
  if (byPriority !== 0) return byPriority;
  return (b.price ?? 0) - (a.price ?? 0);
});

/* =========================
   FILTROS DISPONIBLES (CONTEXTUALES)
========================= */
const filters = buildFilters(cards) as {
  cities: string[];
  areas: Record<string, string[]>;
  types: string[];
  markets: string[];
  bedrooms: number[];
  floors: string[];
  price: { min: number; max: number };
};

const formatFloorLabel = (floorValue) => floorValue;

/* =========================
   SEO
========================= */
const listSeo = normalizePropertyList({
  lang,
  city: activeFilters.city,
  area: activeFilters.area,
  type: activeFilters.type,
  market: activeFilters.market,
  province: "Costa del Sol",
  hasTechnicalFilters,
});

/* =========================
   URL BUILDER
========================= */
function buildUrl(overrides = {}) {
  const params = new URLSearchParams();

  const merged = {
    city: activeFilters.city,
    area: activeFilters.area,
    type: activeFilters.type,
    market: activeFilters.market,
    bedrooms: activeFilters.bedrooms,
    floor: activeFilters.floor,
    priceMin: activeFilters.priceMin,
    priceMax: activeFilters.priceMax,
    q: activeFilters.search,
    ref: activeFilters.ref,
    sort,
    ...overrides,
  };

  Object.entries(merged).forEach(([key, value]) => {
    if (value === null || value === undefined) return;
    if (Array.isArray(value)) {
      value.filter((v) => v !== null && v !== undefined).forEach((v) => {
        params.append(key, String(v));
      });
      return;
    }
    params.set(key, String(value));
  });

  const qs = params.toString();
  return qs ? `?${qs}` : `/${lang}/properties/`;
}
const isFiltered = !!(
  activeFilters.city ||
  activeFilters.area ||
  (activeFilters.type && activeFilters.type.length) ||
  (activeFilters.bedrooms && activeFilters.bedrooms.length) ||
  (activeFilters.floor && activeFilters.floor.length) ||
  activeFilters.market ||
  activeFilters.priceMin ||
  activeFilters.priceMax ||
  activeFilters.search ||
  activeFilters.ref
);
// formatFloorLabel defined above (identity)

const formatMarketLabel = (value) => {
  const def = MARKET_TYPE?.[value];
  return def?.label?.[lang] ?? value;
};
---

<BaseLayout
  title={listSeo.title}
  description={listSeo.description}
  noindex={listSeo.noindex}
  lang={lang}
  availableLangs={SUPPORTED_LANGS}
>
  <div class={`properties-page ${isFiltered ? 'is-filtered' : ''}`}>
    
    <!-- HEADER DE PÃGINA -->
    <header class="properties-header">
      <div class="header-content">
        <h1>{listSeo.title}</h1>
        { !isFiltered && (
          <p class="subtitle">
            {renderText(t.headerSubtitle, {
              location: displayLocation(activeFilters.city) || t.defaultLocation,
            })}
          </p>
        )}
      </div>
    </header>


        {!activeFilters.area && activeFilters.city && (
          <section class="city-exploration-section">
            <div class="exploration-content">
              <div class="exploration-header">
                <span class="exploration-label">{t.exclusiveSelection}</span>
                <h2>{displayLocation(activeFilters.city)}</h2>
                <div class="exploration-divider"></div>
                <p>
                  {renderText(t.explorationIntro, {
                    city: displayLocation(activeFilters.city),
                  })}
                </p>
              </div>
              
              <div class="exploration-links">
                {filters.areas[activeFilters.city]?.length > 0 && (
                  <div class="link-group">
                    <h4>{t.highlightedAreas}</h4>
                    <div class="link-list">
                      {filters.areas[activeFilters.city].map((area: string) => (
                        <a href={buildUrl({ area })} class="text-link">
                          {displayLocation(area)}
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                <div class="link-group">
                  <h4>{renderText(t.propertiesIn, { city: displayLocation(activeFilters.city) })}</h4>
                  <div class="link-list">
                    {filters.types.map((type: string) => (
                      <a href={buildUrl({ type })} class="text-link">
                        {formatPropertyType(type, lang)}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </section>
        )}

    <div class="properties-layout">
      
      <!-- SIDEBAR FILTROS -->
      <aside class="properties-sidebar">
        <div class="filters-sticky">
           <section class="filters-panel">
            <details class="filters-disclosure" id="filtersDisclosure" open>
              <summary class="filters-summary" aria-label={t.openFiltersAria} aria-controls="filtersBody">
                <span>{t.filterProperties}</span>
              </summary>
              <div class="filters-body" id="filtersBody">
                <div class="filters-header desktop-only">
                  <h2>{t.filter}</h2>
                  {(activeFilters.city || activeFilters.area || (activeFilters.type && activeFilters.type.length) || (activeFilters.bedrooms && activeFilters.bedrooms.length) || (activeFilters.floor && activeFilters.floor.length) || activeFilters.market || activeFilters.search || activeFilters.ref) && (
                    <a href={`/${lang}/properties/`} class="reset-all">{t.clearAll}</a>
                  )}
                </div>

            {filters.cities.length > 0 && (
              <div class="filter-group">
                <h3>{t.location}</h3>
                <ul class="filter-list vertical">
                  {filters.cities.map((city: string) => (
                    <li class={city === activeFilters.city ? "active" : ""}>
                      <a href={buildUrl({ city: city === activeFilters.city ? null : city, area: null })}>
                        <span class="check-icon"></span>
                        {displayLocation(city)}
                        {city === activeFilters.city && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {activeFilters.city && filters.areas[activeFilters.city]?.length > 0 && (
              <div class="filter-group">
                <h3>{renderText(t.areasIn, { city: displayLocation(activeFilters.city) })}</h3>
                <ul class="filter-list vertical">
                  {filters.areas[activeFilters.city].map((area: string) => (
                    <li class={area === activeFilters.area ? "active" : ""}>
                      <a href={buildUrl({ area: area === activeFilters.area ? null : area })}>
                         <span class="check-icon"></span>
                        {displayLocation(area)}
                        {area === activeFilters.area && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {(filters.types.length > 1 || (activeFilters.type && activeFilters.type.length)) && (
              <div class="filter-group">
                <h3>{t.propertyType}</h3>
                <ul class="filter-list vertical">
                  {filters.types.map((type: string) => (
                    <li class={activeFilters.type?.includes(type) ? "active" : ""}>
                      <a href={buildUrl({ type: toggleMulti(activeFilters.type, type) })}>
                         <span class="check-icon"></span>
                        {formatPropertyType(type, lang)}
                        {activeFilters.type?.includes(type) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.markets.length > 0 && (
              <div class="filter-group">
                <h3>{t.status}</h3>
                <ul class="filter-list vertical">
                  {filters.markets.map((market: string) => (
                    <li class={market === activeFilters.market ? "active" : ""}>
                      <a href={buildUrl({ market: market === activeFilters.market ? null : market })}>
                        <span class="check-icon"></span>
                        {formatMarketLabel(market)}
                        {market === activeFilters.market && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.bedrooms.length > 0 && (
              <div class="filter-group">
                <h3>{t.bedrooms}</h3>
                <ul class="filter-list vertical">
                  {filters.bedrooms.map((bedrooms: number) => (
                    <li class={activeFilters.bedrooms?.includes(bedrooms) ? "active" : ""}>
                      <a href={buildUrl({ bedrooms: toggleMulti(activeFilters.bedrooms, bedrooms) })}>
                         <span class="check-icon"></span>
                        {bedrooms} {t.bedroomsSuffix}
                        {activeFilters.bedrooms?.includes(bedrooms) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {filters.floors.length > 0 && (
              <div class="filter-group">
                <h3>{t.floor}</h3>
                <ul class="filter-list vertical">
                  {filters.floors.map((floor: string) => (
                    <li class={activeFilters.floor?.includes(floor) ? "active" : ""}>
                      <a href={buildUrl({ floor: toggleMulti(activeFilters.floor, floor) })}>
                        <span class="check-icon"></span>
                        {formatFloorLabel(floor)}
                        {activeFilters.floor?.includes(floor) && (
                          <span class="filter-clear">x</span>
                        )}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
            
              </div>
            </details>
          </section>
        </div>
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="properties-content">
        <script is:inline>
          const disclosure = document.getElementById('filtersDisclosure');
          const mql = window.matchMedia('(min-width: 1024px)');

          const syncFiltersDisclosure = () => {
            if (!disclosure) return;
            if (mql.matches) {
              disclosure.setAttribute('open', '');
            } else {
              disclosure.removeAttribute('open');
            }
          };

          syncFiltersDisclosure();
          mql.addEventListener('change', syncFiltersDisclosure);
        </script>
        
        <!-- BARRA SUPERIOR (Resultados + Ordenar) -->
        <div class="content-header">
          <div class="results-summary">
            <p class="results-count">
              <strong>{sortedCards.length}</strong> {t.propertiesFound}
            </p>
            {activeFilters.search && (
              <p class="results-query">
                {t.resultsFor} "<span>{activeFilters.search}</span>"
              </p>
            )}
          </div>
          
          <div class="sort-dropdown">
             <span>{t.sortBy}</span>
             <div class="sort-options">
                <a href={buildUrl({ sort: "priority" })} class={sort === 'priority' ? 'active' : ''}>{t.relevance}</a>
                <a href={buildUrl({ sort: "price_asc" })} class={sort === 'price_asc' ? 'active' : ''}>{t.priceAsc}</a>
                <a href={buildUrl({ sort: "price_desc" })} class={sort === 'price_desc' ? 'active' : ''}>{t.priceDesc}</a>
             </div>
          </div>
        </div>

        <form class="search-bar" method="get" action={`/${lang}/properties/`}>
          <input
            type="search"
            name="q"
            placeholder={t.searchPlaceholder}
            value={activeFilters.search ?? ""}
            aria-label={t.searchAria}
          />
          {activeFilters.city && (
            <input type="hidden" name="city" value={activeFilters.city} />
          )}
          {activeFilters.area && (
            <input type="hidden" name="area" value={activeFilters.area} />
          )}
          {activeFilters.type?.map((type: string) => (
            <input type="hidden" name="type" value={type} />
          ))}
          {activeFilters.bedrooms?.map((bedroom: number) => (
            <input type="hidden" name="bedrooms" value={bedroom} />
          ))}
          {activeFilters.floor?.map((floor: string) => (
            <input type="hidden" name="floor" value={floor} />
          ))}
          {activeFilters.market && (
            <input type="hidden" name="market" value={activeFilters.market} />
          )}
          {typeof activeFilters.priceMin === "number" && (
            <input type="hidden" name="priceMin" value={activeFilters.priceMin} />
          )}
          {typeof activeFilters.priceMax === "number" && (
            <input type="hidden" name="priceMax" value={activeFilters.priceMax} />
          )}
          {sort && <input type="hidden" name="sort" value={sort} />}
          {activeFilters.ref && <input type="hidden" name="ref" value={activeFilters.ref} />}
          <button type="submit">{t.search}</button>
        </form>

        {sortedCards.length === 0 ? (
          <div class="empty-state">
            <div class="empty-icon">ðŸ”</div>
            <h3>{t.emptyTitle}</h3>
            <p>{t.emptyText}</p>
            <a href={`/${lang}/properties/`} class="btn btn-primary">{t.viewAllProperties}</a>
          </div>
        ) : (
          <>
            <section class="properties-grid">
              {sortedCards.map((data) => (
                <PropertyCard data={data} lang={lang} />
              ))}
            </section>
          </>
        )}

      </main>
    </div>

    <!-- CTA FOOTER (CENTRADOR) -->
    <div class="list-footer-cta">
      <h3>{t.footerTitle}</h3>
      <p>
        {activeFilters.city
          ? renderText(t.footerCityPrompt, { city: displayLocation(activeFilters.city) })
          : t.footerDefaultPrompt}
      </p>
      <a href={`/${lang}/contacto`} class="btn btn-outline">{t.contactUs}</a>
    </div>

  </div>
</BaseLayout>

<script is:inline>
  const shouldHandleLink = (link) => {
    if (!link) return false;
    if (link.target && link.target !== "_self") return false;
    if (link.hasAttribute("download")) return false;
    const href = link.getAttribute("href");
    if (!href || href.startsWith("#")) return false;
    if (link.dataset.noAjax === "true") return false;
    if (href.startsWith("?")) return true;
    return href.includes("/properties");
  };

  const resolveHref = (href) => {
    if (href.startsWith("?")) {
      return `${window.location.pathname}${href}`;
    }
    return href;
  };

  const handleNavigation = async (href) => {
    const targetHref = resolveHref(href);
    const response = await fetch(targetHref, { headers: { "X-Requested-With": "fetch" } });
    if (!response.ok) {
      window.location.href = targetHref;
      return;
    }
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const nextPage = doc.querySelector(".properties-page");
    const currentPage = document.querySelector(".properties-page");
    const nextLayout = doc.querySelector(".properties-layout");
    const currentLayout = document.querySelector(".properties-layout");
    const nextHeader = doc.querySelector(".properties-header");
    const currentHeader = document.querySelector(".properties-header");

    if (nextPage && currentPage) {
      currentPage.className = nextPage.className;
    }
    if (nextHeader && currentHeader) {
      currentHeader.innerHTML = nextHeader.innerHTML;
    }
    if (nextLayout && currentLayout) {
      currentLayout.innerHTML = nextLayout.innerHTML;
    }

    document.title = doc.title;
    history.pushState({}, "", targetHref);

    // Keep filters open on desktop after updates
    const disclosure = document.getElementById("filtersDisclosure");
    const mql = window.matchMedia("(min-width: 1024px)");
    if (disclosure) {
      if (mql.matches) {
        disclosure.setAttribute("open", "");
      } else {
        disclosure.removeAttribute("open");
      }
    }
  };

  document.addEventListener("click", (event) => {
    const link = event.target.closest("a");
    if (!shouldHandleLink(link)) return;
    if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
    event.preventDefault();
    handleNavigation(link.getAttribute("href"));
  });

  window.addEventListener("popstate", () => {
    handleNavigation(window.location.href);
  });
</script>


