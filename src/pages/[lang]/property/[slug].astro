---
import BaseLayout from "@/layouts/BaseLayout.astro";
import RichContent from "@/components/RichContent.astro";
import PropertyHero from "@/components/PropertyHero.astro";
import GallerySection from "@/components/GallerySection.astro";
import LightboxGallery from "@/components/LightboxGallery.astro";

import { getOrderedGallery } from "@/utils/media";
import { formatPrice } from "@/utils/formatters";
import { normalizeProperty } from "@/utils/normalizeProperty";
import properties from "@/data/properties";

/* =========================
   STATIC PATHS
========================= */
export async function getStaticPaths() {
  const LANGS = ["es", "en", "de", "fr", "it", "nl"];

  return properties.flatMap((property) =>
    LANGS.flatMap((lang) => {
      if (!property.slugs?.[lang]) return [];
      return [{
        params: {
          lang,
          slug: property.slugs[lang],
        },
      }];
    })
  );
}

/* =========================
   PARAMS
========================= */
const { slug } = Astro.params;
const lang = "es";
const agent = {
  phone: "+34 600 123 456",
  email: "info@blancareal.com",
};

/* =========================
   RESOLVER PROPIEDAD
========================= */
const property = properties.find(
  (p) => p.slugs?.[lang] === slug
);

if (!property) {
  throw new Error(`Property not found: ${lang}/${slug}`);
}

/* =========================
   NORMALIZACIÓN (ÚNICA FUENTE)
========================= */
const data = normalizeProperty(property, lang);

if (!data || !data.visible) {
  throw new Error(`Property is private or not available: ${lang}/${slug}`);
}

/* =========================
   DERIVADOS SEGUROS
========================= */
const orderedImages = getOrderedGallery(data.media);
const canonicalUrl = `https://blancareal.com/${lang}/property/${slug}/`;
const isPromotion =
  data.isPromotion ?? property.listing_type === "promotion";
const unitsRaw = isPromotion
  ? properties.filter(
      (p) =>
        String(p.parent_id) === String(property.id) &&
        p.listing_type === "unit" &&
        (p.status ?? "available") === "available" &&
        p.slugs?.[lang]
    )
  : [];
const units = unitsRaw
  .map((unit) => ({
    raw: unit,
    data: normalizeProperty(unit, lang),
  }))
  .filter(
    (unit) =>
      unit.data &&
      unit.data.visible &&
      unit.raw?.slugs?.[lang]
  );

const getUnitNumber = (unit) => {
  const id = unit?.raw?.id ?? "";
  if (id.includes("-")) return id.split("-").pop();
  return id || "-";
};

---

<BaseLayout
  title={data.seo.title}
  description={data.seo.description}
  noindex={data.seo.noindex}
  og={data.seo.og}
  url={canonicalUrl}
  lang={lang}
>
  <PropertyHero
    cover={data.media.cover}
    title={data.text.title}
    location={`${data.location.area}, ${data.location.province}`}
    lang={lang}
  />

  <div class="property-container">
    
    <!-- MAIN CONTENT -->
    <div class="property-main">

      <!-- RESUMEN -->
      <section class="section-intro" aria-labelledby="intro-title">
        <span class="editorial-label">Ficha rápida</span>
        <h2 class="section-title" id="intro-title">Resumen ejecutivo</h2>
        <p class="intro-subtitle">
          Una visión clara de la propiedad con los datos que más importan al decidir una visita.
        </p>
        <dl class="key-facts">
          {data.price !== null && (
            <div class="key-fact">
              <dt>Precio</dt>
              <dd>{formatPrice(data.price, data.currency, lang)}</dd>
            </div>
          )}
          {data.details.bedrooms && (
            <div class="key-fact">
              <dt>Dormitorios</dt>
              <dd>{data.details.bedrooms}</dd>
            </div>
          )}
          {data.details.bathrooms && (
            <div class="key-fact">
              <dt>Baños</dt>
              <dd>{data.details.bathrooms}</dd>
            </div>
          )}
          {data.details.area_m2 && (
            <div class="key-fact">
              <dt>Superficie construida</dt>
              <dd>{data.details.area_m2} m²</dd>
            </div>
          )}
          {data.details.usable_area_m2 && (
            <div class="key-fact">
              <dt>Superficie útil</dt>
              <dd>{data.details.usable_area_m2} m²</dd>
            </div>
          )}
          {data.details.terrace_m2 && (
            <div class="key-fact">
              <dt>Terraza</dt>
              <dd>{data.details.terrace_m2} m²</dd>
            </div>
          )}
          {data.details.garden_m2 && (
            <div class="key-fact">
              <dt>Jardín</dt>
              <dd>{data.details.garden_m2} m²</dd>
            </div>
          )}
          {data.details.orientation && (
            <div class="key-fact">
              <dt>Orientación</dt>
              <dd>{data.details.orientation}</dd>
            </div>
          )}
          {data.details.garages && (
            <div class="key-fact">
              <dt>Plazas de garaje</dt>
              <dd>{data.details.garages}</dd>
            </div>
          )}
        </dl>
        {isPromotion && units.length > 0 && (
          <div class="summary-cta">
            <a href="#units" class="btn-premium primary">
              Ver viviendas disponibles
            </a>
            <p class="summary-note">
              Más abajo encontrará el listado completo de unidades disponibles.
            </p>
          </div>
        )}
      </section>

      {isPromotion && units.length > 0 && (
        <section class="section-units" aria-labelledby="units-title" id="units">
          <span class="editorial-label">Disponibilidad</span>
          <h2 class="section-title" id="units-title">Viviendas disponibles</h2>
          <div class="luxury-divider"></div>
          <table class="units-table">
            <caption class="sr-only">Listado de viviendas disponibles</caption>
            <thead>
              <tr>
                <th>Unidad</th>
                <th>Dormitorios</th>
                <th>Superficie (m²)</th>
                <th>Precio</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {units.map((unit) => (
                <tr>
                  <td>{getUnitNumber(unit)}</td>
                  <td>{unit.data.details.bedrooms ?? "-"}</td>
                  <td>{unit.data.details.area_m2 ?? "-"}</td>
                  <td>
                    {unit.data.price !== null
                      ? formatPrice(
                          unit.data.price,
                          unit.data.currency,
                          lang
                        )
                      : "-"}
                  </td>
                  <td>
                    <a
                      href={`/${lang}/property/${unit.raw.slugs[lang]}`}
                      class="text-link-luxury"
                    >
                      Ver unidad
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}

      <!-- DESCRIPCIÓN -->
      <section class="section-details" aria-labelledby="details-title">
        <span class="editorial-label">Presentación</span>
        <h2 class="section-title" id="details-title">Sobre esta propiedad</h2>
        <div class="luxury-divider"></div>
        
        <div class="expandable-description" id="descContainer">
          <div class="description-content" id="descContent">
            {data.text.description?.length > 0 && (
              <RichContent blocks={data.text.description} />
            )}
          </div>
          <button
            class="read-more-btn"
            id="readMoreBtn"
            type="button"
            aria-expanded="false"
            aria-controls="descContent"
          >
            Leer más
          </button>
        </div>
      </section>

      <script is:inline>
        const btn = document.getElementById('readMoreBtn');
        const container = document.getElementById('descContainer');
        
        if (btn && container) {
          btn.addEventListener('click', () => {
            const isExpanded = container.classList.toggle('is-expanded');
            btn.setAttribute('aria-expanded', String(isExpanded));
            btn.textContent = isExpanded ? 'Leer menos' : 'Leer más';
          });
        }
      </script>

      <!-- UBICACIÓN Y ASESORAMIENTO -->
      <section class="section-advisory" aria-labelledby="advisory-title">
        <span class="editorial-label">Ubicación</span>
        <h2 class="section-title" id="advisory-title">Vida en {data.location.area}</h2>
        <div class="luxury-divider"></div>
        <p class="advisory-text">
          Esta propiedad se encuentra en una de las zonas más privilegiadas de {data.location.province}.
          Nuestro equipo de expertos locales le guiará en cada paso para asegurar que su transición a este exclusivo entorno sea impecable.
        </p>
        <div class="advisory-links">
          <a href={`/${lang}/properties/`} class="text-link-luxury">
            Explorar todas las propiedades
          </a>
          <a href={`/${lang}/properties/?area=${data.location.area}`} class="text-link-luxury">
            Propiedades en {data.location.area}
          </a>
        </div>
      </section>

      <!-- GALERÍAS -->
      <section class="galleries-wrapper" aria-labelledby="galleries-title">
        <span class="editorial-label">Catálogo visual</span>
        <h2 class="section-title" id="galleries-title">Inmersión en la propiedad</h2>
        <div class="luxury-divider"></div>
        
        <div class="property-galleries">
           <GallerySection title="Exterior y Alrededores" items={data.media.gallery.exterior} category="exterior" />
           <GallerySection title="Ambientes Interiores" items={data.media.gallery.interior} category="interior" />
           
           {data.media.gallery.views?.length > 0 && (
              <GallerySection title="Zonas Comunes y Vistas" items={data.media.gallery.views} category="views" />
           )}
           
           {data.media.gallery.floorplan?.length > 0 && (
              <GallerySection title="Planimetría" items={data.media.gallery.floorplan} category="plans" />
           )}
        </div>
      </section>

    </div>

    <!-- SIDEBAR -->
    <aside class="property-sidebar">
      <div class="concierge-card">
        {data.price && (
          <div class="price-section">
             <span class="concierge-label">Inversión</span>
             <p class="premium-price">
              {formatPrice(data.price, data.currency, lang)}
            </p>
          </div>
        )}
        
        <div class="concierge-actions">
          <h3 class="concierge-title">Servicio Concierge</h3>
          <p class="concierge-desc">Solicite información personalizada o agende una visita privada.</p>

          <div class="action-buttons">
            <a href={`tel:${agent.phone}`} class="btn-premium primary">
              Llamar ahora
            </a>
            
            <details class="concierge-expandable">
              <summary class="btn-premium secondary">Solicitar Dossier</summary>
              <div class="expandable-content">
                <p>Nuestra oficina de <strong>{data.location.province}</strong> le enviará los detalles completos.</p>
                <a href={`mailto:${agent.email}?subject=Dossier Ref: ${data.id || slug}`} class="email-direct">
                  {agent.email}
                </a>
              </div>
            </details>

            <details class="concierge-expandable">
              <summary class="btn-premium outline">Agendar Visita</summary>
              <div class="expandable-content">
                 <form class="luxury-form" onsubmit="event.preventDefault()">
                    <label class="sr-only" for="visit-name">Nombre</label>
                    <input id="visit-name" type="text" placeholder="Su Nombre" autocomplete="name" required />
                    <label class="sr-only" for="visit-email">Email</label>
                    <input id="visit-email" type="email" placeholder="Email de contacto" autocomplete="email" required />
                    <button type="submit" class="btn-send">Enviar Solicitud</button>
                 </form>
              </div>
            </details>
          </div>

          <div class="property-reference">
             <span>Referencia Especial</span>
             <strong>{data.id || slug}</strong>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- UBICACIÓN (MAPA) -->
  {data.location.coordinates && (
    <section class="section-map" aria-labelledby="map-title">
      <div class="map-container">
        <span class="editorial-label">Localización</span>
        <h2 class="section-title" id="map-title">Ubicación privilegiada</h2>
        <div class="luxury-divider"></div>
        
        <div class="map-wrapper">
          <iframe
            width="100%"
            height="450"
            style="border:0; border-radius: 1rem;"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            title={`Mapa de ubicación en ${data.location.area}`}
            src={`https://maps.google.com/maps?q=${data.location.coordinates.lat},${data.location.coordinates.lng}&z=15&output=embed`}
          ></iframe>
        </div>
        <p class="map-note">
          * La ubicación exacta se proporcionará tras agendar una visita privada por motivos de seguridad y privacidad.
        </p>
      </div>
    </section>
  )}
</BaseLayout>
