---
export const prerender = false;

import BaseLayout from "@/layouts/BaseLayout.astro";
import properties from "@/data/properties";
import PropertyCard from "@/components/PropertyCard.astro";

import { normalizePropertyCard } from "@/utils/normalizePropertyCard";
import { normalizePropertyList } from "@/utils/normalizePropertyList";
import { buildFilters } from "@/utils/buildFilters";
import { applyFilters } from "@/utils/applyFilters";
import { normalizeCity } from "@/utils/normalizeCity";
import { normalizeArea } from "@/utils/normalizeArea";

const lang = "es";

/* =========================
   FILTROS ACTIVOS (QUERY PARAMS)
========================= */
const { searchParams } = Astro.url;

const activeFilters = {
  city: searchParams.get("city")
    ? normalizeCity(searchParams.get("city"))
    : null,

  area: searchParams.get("area")
    ? normalizeArea(searchParams.get("area"))
    : null,

  type: searchParams.get("type") || null,
  market: searchParams.get("market") || null,

  priceMin: searchParams.get("priceMin")
    ? Number(searchParams.get("priceMin"))
    : null,

  priceMax: searchParams.get("priceMax")
    ? Number(searchParams.get("priceMax"))
    : null,
};

const hasTechnicalFilters =
  searchParams.has("sort") ||
  searchParams.has("page");

/* =========================
   LISTADO NORMALIZADO
========================= */
const cards = properties
  .map((p) => normalizePropertyCard(p, lang))
  .filter(Boolean)
  .filter((p) => p.visible);

/* =========================
   APLICAR FILTROS
========================= */
const filteredCards = applyFilters(cards, activeFilters);

/* =========================
   ORDENACIÓN
========================= */
const sort = searchParams.get("sort") ?? "price_asc";

const sortedCards = [...filteredCards].sort((a, b) => {
  if (sort === "price_desc") return b.price - a.price;
  return a.price - b.price;
});

/* =========================
   FILTROS DISPONIBLES (CONTEXTUALES)
========================= */
const filters = buildFilters(
  sortedCards.length ? sortedCards : cards
);

/* =========================
   SEO
========================= */
const listSeo = normalizePropertyList({
  lang,
  city: activeFilters.city,
  area: activeFilters.area,
  type: activeFilters.type,
  market: activeFilters.market,
  province: "Costa del Sol",
  hasTechnicalFilters,
});

/* =========================
   URL BUILDER
========================= */
function buildUrl(overrides = {}) {
  const params = new URLSearchParams();

  const merged = {
    city: activeFilters.city,
    area: activeFilters.area,
    type: activeFilters.type,
    market: activeFilters.market,
    priceMin: activeFilters.priceMin,
    priceMax: activeFilters.priceMax,
    sort,
    ...overrides,
  };

  Object.entries(merged).forEach(([key, value]) => {
    if (value !== null && value !== undefined) {
      params.set(key, String(value));
    }
  });

  const qs = params.toString();
  return qs ? `?${qs}` : "";
}
---

<BaseLayout
  title={listSeo.title}
  description={listSeo.description}
  noindex={listSeo.noindex}
  lang={lang}
>
  <h1>{listSeo.title}</h1>

  <p class="list-context">
    {sortedCards.length > 0 && (
      <>
        Mostrando <strong>{activeFilters.type ?? "propiedades"}</strong>
        {activeFilters.city && <> en <strong>{activeFilters.city}</strong></>}
        {activeFilters.area && <> / <strong>{activeFilters.area}</strong></>}
      </>
    )}
  </p>

  <p class="results-count">
    {sortedCards.length}
    {sortedCards.length === 1
      ? " propiedad encontrada"
      : " propiedades encontradas"}
  </p>

  {(activeFilters.city ||
    activeFilters.area ||
    activeFilters.type ||
    activeFilters.market ||
    activeFilters.priceMin ||
    activeFilters.priceMax) && (
    <div class="active-filters">
      <div class="chips">
        {activeFilters.city && (
          <a class="chip" href={buildUrl({ city: null, area: null })} rel="nofollow">
            Ciudad: {activeFilters.city} ×
          </a>
        )}

        {activeFilters.area && (
          <a class="chip" href={buildUrl({ area: null })} rel="nofollow">
            Zona: {activeFilters.area} ×
          </a>
        )}

        {activeFilters.type && (
          <a class="chip" href={buildUrl({ type: null })} rel="nofollow">
            Tipo: {activeFilters.type} ×
          </a>
        )}

        {(activeFilters.priceMin || activeFilters.priceMax) && (
          <a
            class="chip"
            href={buildUrl({ priceMin: null, priceMax: null })}
            rel="nofollow"
          >
            Precio ×
          </a>
        )}

        <a class="chip chip--reset" href={`/${lang}/properties/`} rel="nofollow">
          Limpiar todo
        </a>
      </div>
    </div>
  )}

  <section class="filters">
    <h2 class="filters-title">Filtrar propiedades</h2>

    {filters.cities.length > 1 && (
      <div class="filter-group">
        <h3>Ciudad</h3>
        <ul class="filter-list">
          {filters.cities.map((city) => (
            <li class={city === activeFilters.city ? "active" : ""}>
              <a href={buildUrl({ city, area: null })}>{city}</a>
            </li>
          ))}
        </ul>
      </div>
    )}

    {activeFilters.city &&
      filters.areas[activeFilters.city]?.length > 0 && (
        <div class="filter-group">
          <h3>Zona</h3>
          <ul class="filter-list">
            {filters.areas[activeFilters.city].map((area) => (
              <li class={area === activeFilters.area ? "active" : ""}>
                <a href={buildUrl({ area })}>{area}</a>
              </li>
            ))}
          </ul>
        </div>
      )}

    {filters.types.length > 1 && (
      <div class="filter-group">
        <h3>Tipo de propiedad</h3>
        <ul class="filter-list">
          {filters.types.map((type) => (
            <li class={type === activeFilters.type ? "active" : ""}>
              <a href={buildUrl({ type })}>{type}</a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </section>

  <div class="sort-bar">
    <span>Ordenar por:</span>
    <a href={buildUrl({ sort: "price_asc" })}>Precio ↑</a>
    <a href={buildUrl({ sort: "price_desc" })}>Precio ↓</a>
  </div>

  <hr />

  {sortedCards.length === 0 ? (
    <div class="empty-state">
      <p>No hay propiedades que coincidan con estos filtros.</p>

      <ul>
        {activeFilters.area && (
          <li>
            <a href={buildUrl({ area: null })}>
              Quitar zona ({activeFilters.area})
            </a>
          </li>
        )}

        {activeFilters.city && (
          <li>
            <a href={buildUrl({ city: null, area: null })}>
              Ver todas en {activeFilters.city}
            </a>
          </li>
        )}
      </ul>

      <a href={`/${lang}/properties/`} class="btn">
        Ver todas las propiedades
      </a>
    </div>
  ) : (
    <>
      <section class="properties-grid">
        {sortedCards.map((data) => (
          <PropertyCard data={data} lang={lang} />
        ))}
      </section>

      <section class="list-seo-copy">
        <p>
          Descubre {activeFilters.type ?? "propiedades"} en{" "}
          {activeFilters.area
            ? `${activeFilters.area}, ${activeFilters.city}`
            : activeFilters.city ?? "la Costa del Sol"}.
          Nuestro catálogo incluye opciones cuidadosamente seleccionadas
          para vivir o invertir con seguridad.
        </p>
      </section>

      <div class="list-cta">
        <p>
          ¿Buscas {activeFilters.type ?? "una propiedad"}
          {activeFilters.city && <> en {activeFilters.city}</>}?
        </p>
        <a href="/contacto" class="btn-primary">
          Te ayudamos sin compromiso
        </a>
      </div>
    </>
  )}
</BaseLayout>
