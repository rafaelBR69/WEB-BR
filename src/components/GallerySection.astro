---
import { buildSupabaseImageUrl, buildSupabaseSrcSet } from "@/utils/supabaseImage";

const { title, items = [], category = "general", lang = "es" } = Astro.props;

const labelsByLang = {
  es: {
    image: "Imagen",
    pdf: "Plano PDF",
    openPdf: "Abrir plano",
    viewLarge: "Ver en grande",
    openImage: "Abrir imagen",
    imageOf: "de",
  },
  en: {
    image: "Image",
    pdf: "PDF floorplan",
    openPdf: "Open floorplan",
    viewLarge: "View full size",
    openImage: "Open image",
    imageOf: "of",
  },
  de: {
    image: "Bild",
    pdf: "PDF Grundriss",
    openPdf: "Grundriss oeffnen",
    viewLarge: "Gross anzeigen",
    openImage: "Bild oeffnen",
    imageOf: "von",
  },
  fr: {
    image: "Image",
    pdf: "Plan PDF",
    openPdf: "Ouvrir le plan",
    viewLarge: "Voir en grand",
    openImage: "Ouvrir l image",
    imageOf: "sur",
  },
  it: {
    image: "Immagine",
    pdf: "Planimetria PDF",
    openPdf: "Apri planimetria",
    viewLarge: "Vedi grande",
    openImage: "Apri immagine",
    imageOf: "di",
  },
  nl: {
    image: "Afbeelding",
    pdf: "PDF plattegrond",
    openPdf: "Open plattegrond",
    viewLarge: "Vergroot bekijken",
    openImage: "Open afbeelding",
    imageOf: "van",
  },
};

const t = labelsByLang[lang] ?? labelsByLang.es;

if (!items || !items.length) return null;

const imageIndexByItem = new Map<number, number>();
let imageTotal = 0;

items.forEach((img: any, index: number) => {
  const url = String(img?.url ?? "");
  if (url && !url.toLowerCase().endsWith(".pdf")) {
    imageTotal += 1;
    imageIndexByItem.set(index, imageTotal);
  }
});
---
<div class={`gallery-category category-${category}`}>
  <div class="gallery-category-head">
    <h3 class="category-title">{title}</h3>
    {imageTotal > 0 && (
      <p class="category-count">{imageTotal} {t.image.toLowerCase()}</p>
    )}
  </div>
  
  <div class="gallery-mosaic">
    {items.map((img: any, index: number) => {
      const fallbackAlt = `${title} - ${t.image} ${index + 1}`;
      const altText = img.alt || fallbackAlt;
      const url = img.url ?? "";
      const isPdf = url.toLowerCase().endsWith(".pdf");
      const imagePosition = imageIndexByItem.get(index) ?? null;
      const previewWidth = index === 0 ? 1280 : 640;
      const previewSrc = buildSupabaseImageUrl(url, {
        width: previewWidth,
        quality: 72,
      });
      const previewSrcSet = buildSupabaseSrcSet(
        url,
        index === 0 ? [640, 960, 1280] : [320, 480, 640],
        { quality: 72 }
      );
      const previewSizes =
        index === 0
          ? "(max-width: 900px) 100vw, 66vw"
          : "(max-width: 900px) 50vw, 33vw";

      if (isPdf) {
        return (
          <a
            href={url}
            class={`mosaic-item pdf ${index === 0 ? "main" : "thumb"}`}
            title={altText}
            aria-label={`${t.openPdf}: ${altText}`}
            target="_blank"
            rel="noreferrer"
          >
            <div class="pdf-card">
              <span class="pdf-label">{t.pdf}</span>
              <span class="pdf-action">{t.openPdf}</span>
            </div>
          </a>
        );
      }

      return (
        <a
          href={url}
          class={`mosaic-item ${index === 0 ? "main" : "thumb"}`}
          data-lightbox="property-gallery"
          data-lightbox-alt={altText}
          data-lightbox-caption={altText}
          title={altText}
          aria-label={`${t.openImage} ${imagePosition ?? index + 1} ${t.imageOf} ${imageTotal}: ${altText}`}
        >
          <img
            src={previewSrc || url}
            srcset={previewSrcSet || undefined}
            sizes={previewSizes}
            data-fallback-src={url}
            onerror="if(!this.dataset.fallbackApplied){this.dataset.fallbackApplied='1';this.src=this.dataset.fallbackSrc||this.src;this.srcset='';}"
            alt={altText}
            loading="lazy"
            decoding="async"
          />
          <div class="mosaic-overlay">
            <span>{t.viewLarge}</span>
            {imagePosition && (
              <small>{imagePosition} / {imageTotal}</small>
            )}
          </div>
        </a>
      );
    })}
  </div>
</div>
