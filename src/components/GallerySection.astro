---
import { buildSupabaseImageUrl, buildSupabaseSrcSet } from "@/utils/supabaseImage";

const { title, items = [], category = "general", lang = "es" } = Astro.props;

const labelsByLang = {
  es: {
    image: "Imagen",
    pdf: "Plano PDF",
    openPdf: "Abrir plano",
    viewLarge: "Ver en grande",
  },
  en: {
    image: "Image",
    pdf: "PDF floorplan",
    openPdf: "Open floorplan",
    viewLarge: "View full size",
  },
  de: {
    image: "Bild",
    pdf: "PDF Grundriss",
    openPdf: "Grundriss oeffnen",
    viewLarge: "Gross anzeigen",
  },
  fr: {
    image: "Image",
    pdf: "Plan PDF",
    openPdf: "Ouvrir le plan",
    viewLarge: "Voir en grand",
  },
  it: {
    image: "Immagine",
    pdf: "Planimetria PDF",
    openPdf: "Apri planimetria",
    viewLarge: "Vedi grande",
  },
  nl: {
    image: "Afbeelding",
    pdf: "PDF plattegrond",
    openPdf: "Open plattegrond",
    viewLarge: "Vergroot bekijken",
  },
};

const t = labelsByLang[lang] ?? labelsByLang.es;

if (!items || !items.length) return null;
---
<div class={`gallery-category category-${category}`}>
  <h3 class="category-title">{title}</h3>
  
  <div class="gallery-mosaic">
    {items.map((img: any, index: number) => {
      const fallbackAlt = `${title} - ${t.image} ${index + 1}`;
      const altText = img.alt || fallbackAlt;
      const url = img.url ?? "";
      const isPdf = url.toLowerCase().endsWith(".pdf");
      const previewWidth = index === 0 ? 1280 : 640;
      const previewSrc = buildSupabaseImageUrl(url, {
        width: previewWidth,
        quality: 72,
      });
      const previewSrcSet = buildSupabaseSrcSet(
        url,
        index === 0 ? [640, 960, 1280] : [320, 480, 640],
        { quality: 72 }
      );
      const previewSizes =
        index === 0
          ? "(max-width: 900px) 100vw, 66vw"
          : "(max-width: 900px) 50vw, 33vw";

      if (isPdf) {
        return (
          <a
            href={url}
            class={`mosaic-item pdf ${index === 0 ? "main" : "thumb"}`}
            title={altText}
            target="_blank"
            rel="noreferrer"
          >
            <div class="pdf-card">
              <span class="pdf-label">{t.pdf}</span>
              <span class="pdf-action">{t.openPdf}</span>
            </div>
          </a>
        );
      }

      return (
        <a
          href={url}
          class={`mosaic-item ${index === 0 ? "main" : "thumb"}`}
          data-lightbox="property"
          title={altText}
        >
          <img
            src={previewSrc || url}
            srcset={previewSrcSet || undefined}
            sizes={previewSizes}
            data-fallback-src={url}
            onerror="if(!this.dataset.fallbackApplied){this.dataset.fallbackApplied='1';this.src=this.dataset.fallbackSrc||this.src;this.srcset='';}"
            alt={altText}
            loading="lazy"
            decoding="async"
          />
          <div class="mosaic-overlay">
            <span>{t.viewLarge}</span>
          </div>
        </a>
      );
    })}
  </div>
</div>
