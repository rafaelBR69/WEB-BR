---
import { formatPrice } from "@/utils/formatters";
import { formatArea } from "@/utils/presentation";
import FeatureBadge from "@/components/FeatureBadge.astro";
import { buildSupabaseImageUrl, buildSupabaseSrcSet } from "@/utils/supabaseImage";
import { getUiCopy } from "@/i18n/ui";

const { data, lang } = Astro.props;
const coverUrl = typeof data.cover === "string" ? data.cover : data.cover?.url;
const coverAlt =
  (typeof data.cover === "object" ? data.cover?.alt?.[lang] : null) ||
  (typeof data.cover === "object" ? data.cover?.alt?.es : null) ||
  data.title;
const coverSrc = coverUrl
  ? buildSupabaseImageUrl(coverUrl, { width: 720, quality: 72 })
  : null;
const coverSrcSet = coverUrl
  ? buildSupabaseSrcSet(coverUrl, [320, 480, 640, 720], { quality: 72 })
  : "";

const ui = getUiCopy(lang);
const label = ui.propertyCard.viewDetails;
---

<article class="property-card">
  <div class="card-image">
    <a href={`/${lang}/property/${data.slug}`} aria-label={data.title}>
      {coverUrl ? (
        <img
          src={coverSrc ?? coverUrl}
          srcset={coverSrcSet || undefined}
          sizes="(max-width: 768px) 92vw, (max-width: 1200px) 46vw, 380px"
          data-fallback-src={coverUrl}
          onerror="if(!this.dataset.fallbackApplied){this.dataset.fallbackApplied='1';this.src=this.dataset.fallbackSrc||this.src;this.srcset='';}"
          alt={coverAlt}
          loading="lazy"
          decoding="async"
        />
      ) : (
        <div class="no-image-placeholder"></div>
      )}
    </a>

    {data.isPromotion && (
      <span class="badge-promotion">
        {ui.propertyCard.newBuild}
      </span>
    )}
  </div>

  <div class="card-content">
    <header class="header">
      <h3 class="title">
        <a href={`/${lang}/property/${data.slug}`}>
          {data.title}
        </a>
      </h3>

      <div class="price-row">
        {data.isPromotion ? (
          data.priceFrom && (
            <p class="price">
              {ui.propertyCard.fromPrice} {formatPrice(data.priceFrom, data.currency, lang)}
            </p>
          )
        ) : (
          data.price && (
            <p class="price">
              {formatPrice(data.price, data.currency, lang)}
            </p>
          )
        )}
      </div>
    </header>

    {!data.isPromotion && (
      <ul class="meta">
        {data.details.bedrooms && (
          <li>
            <span class="icon">üõè</span> {data.details.bedrooms}
          </li>
        )}

        {data.details.bathrooms && (
          <li>
            <span class="icon">üöø</span> {data.details.bathrooms}
          </li>
        )}

        {formatArea(data.details.area_m2, lang) && (
          <li>
            <span class="icon">üìê</span> {formatArea(data.details.area_m2, lang)}
          </li>
        )}
      </ul>
    )}

    {data.features.length > 0 && (
      <div class="features">
        {data.features.slice(0, 3).map((f) => (
          <FeatureBadge icon={f.icon} label={f.label} />
        ))}
        {data.features.length > 3 && (
          <span class="more-features">+{data.features.length - 3}</span>
        )}
      </div>
    )}

    <div class="card-actions">
      <a href={`/${lang}/property/${data.slug}`} class="btn-card">{label}</a>
    </div>
  </div>
</article>
