---
const {
  token,
  styleUrl = "mapbox://styles/mapbox/standard",
  features = [],
  poisUrl = "/data/pois.geojson",
  zonesUrl = "/data/zones.geojson",
  poiFilters = [
    { id: "restaurant", label: "Restaurantes" },
    { id: "hospital", label: "Hospitales" },
    { id: "school", label: "Colegios" },
    { id: "pharmacy", label: "Farmacias" },
    { id: "airport", label: "Aeropuertos" },
    { id: "leisure", label: "Ocio" },
  ],
  emptyMessage = "No hay ubicaciones disponibles en el mapa.",
  zoneFilterLabel = "Zonas",
  allZonesLabel = "Sin filtro",
  subzoneFilterLabel = "Subzonas",
  allSubzonesLabel = "Todas",
  poiLabel = "Puntos de interes",
  listTitle = "Resultados visibles",
  routePlannerTitle = "Ruta",
  routePlannerHint = "Pulsa 'Iniciar ruta' en una vivienda y luego elige un POI o resultado como destino.",
  routeStartLabel = "Iniciar ruta",
  routeClearLabel = "Limpiar ruta",
  routeDistanceLabel = "Distancia",
  routeDurationLabel = "Tiempo estimado",
  routeSelectionHint = "Selecciona una vivienda para comenzar la ruta.",
  openDetailLabel = "Ver ficha",
  resetViewLabel = "Reiniciar mapa",
} = Astro.props;

const featureCollection = {
  type: "FeatureCollection",
  features,
};
---

<section class="map-layout">
  <div class="map-main">
    <div class="map-reset-wrap">
      <button type="button" class="map-action map-action-alt map-reset-view-btn" id="resetViewBtn">
        {resetViewLabel}
      </button>
    </div>
    <div
      id="costaMap"
      class="costa-map"
      data-token={token}
      data-style={styleUrl}
      data-features={JSON.stringify(featureCollection)}
      data-pois-url={poisUrl}
      data-zones-url={zonesUrl}
      data-poi-filters={JSON.stringify(poiFilters)}
      data-empty={emptyMessage}
      data-open-detail-label={openDetailLabel}
      data-route-start-label={routeStartLabel}
    ></div>
    <section class="map-poi-overlay" aria-label={poiLabel}>
      <p class="map-poi-overlay-title">{poiLabel}</p>
      <div class="poi-filters poi-filters-overlay" id="poiFilters">
        {poiFilters.map((filter) => (
          <button type="button" class="poi-chip poi-chip-overlay" data-category={filter.id}>
            <span class="poi-chip-icon" aria-hidden="true">
              {filter.id === "restaurant" ? (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><path d="M6 3v8M4.5 3v4M7.5 3v4M6 11v10M15 3l-3 8h5l-1.2 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ) : filter.id === "hospital" ? (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/></svg>
              ) : filter.id === "school" ? (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><path d="M3 9l9-4 9 4-9 4-9-4Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M7 11v4c0 1.7 2.2 3 5 3s5-1.3 5-3v-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              ) : filter.id === "pharmacy" ? (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><rect x="4" y="9" width="16" height="6" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 9v6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
              ) : filter.id === "airport" ? (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><path d="M2 12h20M12 3v18M6 8l6 3 6-3M7 16l5-2 5 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ) : (
                <svg viewBox="0 0 24 24" class="poi-chip-icon-svg"><path d="m12 3 2.6 5.2 5.7.8-4.1 4 1 5.7-5.2-2.8-5.2 2.8 1-5.7-4.1-4 5.7-.8Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
              )}
            </span>
            <span>{filter.label}</span>
          </button>
        ))}
      </div>
    </section>
    <section class="map-route-overlay" aria-label={routePlannerTitle} id="routeOverlay" hidden>
      <p class="map-route-overlay-title">{routePlannerTitle}</p>
      <button type="button" class="map-action map-action-alt map-route-clear-btn" id="routeClearBtn">{routeClearLabel}</button>
      <p class="route-selection route-selection-overlay" id="routeSelectionState">{routeSelectionHint}</p>
      <div class="route-metrics route-metrics-overlay" id="routeMetrics" hidden>
        <p><strong>{routeDistanceLabel}:</strong> <span id="routeDistanceValue"></span></p>
        <p><strong>{routeDurationLabel}:</strong> <span id="routeDurationValue"></span></p>
      </div>
    </section>
  </div>

  <aside class="map-nav">
    <section class="nav-section" data-step="1">
      <p class="map-filter-title">{zoneFilterLabel}</p>
      <div class="zone-filters" id="zoneFilters" data-all-label={allZonesLabel}></div>
    </section>

    <section class="nav-section" data-step="2">
      <p class="map-filter-title">{subzoneFilterLabel}</p>
      <div class="zone-filters" id="areaFilters" data-all-label={allSubzonesLabel}></div>
    </section>

    <section class="nav-section nav-results" data-step="3">
      <h3>{listTitle}</h3>
      <ul class="map-result-list" id="mapResults"></ul>
    </section>
  </aside>
</section>

<script>
  const [
    mapboxModule,
    ,
    turfHelpers,
    distanceModule,
    booleanPointInPolygonModule,
  ] = await Promise.all([
    import("mapbox-gl"),
    import("mapbox-gl/dist/mapbox-gl.css"),
    import("@turf/helpers"),
    import("@turf/distance"),
    import("@turf/boolean-point-in-polygon"),
  ]);

  const mapboxgl = mapboxModule.default;
  const { point } = turfHelpers;
  const distance = distanceModule.default;
  const booleanPointInPolygon = booleanPointInPolygonModule.default;

  const mapEl = document.getElementById("costaMap");
  const routeClearBtn = document.getElementById("routeClearBtn");
  const routeOverlay = document.getElementById("routeOverlay");
  const routeSelectionState = document.getElementById("routeSelectionState");
  const routeMetrics = document.getElementById("routeMetrics");
  const routeDistanceValue = document.getElementById("routeDistanceValue");
  const routeDurationValue = document.getElementById("routeDurationValue");
  const resetViewBtn = document.getElementById("resetViewBtn");
  const poiFiltersEl = document.getElementById("poiFilters");
  const zoneFiltersEl = document.getElementById("zoneFilters");
  const areaFiltersEl = document.getElementById("areaFilters");
  const resultsListEl = document.getElementById("mapResults");

  if (!(mapEl instanceof HTMLDivElement)) {
    throw new Error("Map container not found.");
  }

  const token = mapEl.dataset.token || "";
  const style = mapEl.dataset.style || "mapbox://styles/mapbox/standard";
  const emptyMessage = mapEl.dataset.empty || "No hay ubicaciones disponibles.";
  const openDetailLabel = mapEl.dataset.openDetailLabel || "Ver ficha";
  const routeStartLabel = mapEl.dataset.routeStartLabel || "Iniciar ruta";
  const featureCollection = JSON.parse(mapEl.dataset.features || '{"type":"FeatureCollection","features":[]}');
  const poisUrl = mapEl.dataset.poisUrl || "/data/pois.geojson";
  const zonesUrl = mapEl.dataset.zonesUrl || "/data/zones.geojson";
  const poiFilters = JSON.parse(mapEl.dataset.poiFilters || "[]");

  if (!token) {
    mapEl.innerHTML = `<div class="map-empty">${emptyMessage} (falta PUBLIC_MAPBOX_TOKEN)</div>`;
  } else {
    mapboxgl.accessToken = token;

    const DETAIL_ZOOM = 16;
    const PROPERTY_FOCUS_ZOOM = 17.4;
    const ZONE_HIDE_ZOOM = 12.5;
    const INITIAL_CENTER = [-4.92, 36.58];
    const INITIAL_ZOOM = 9.6;

    const withStableId = (rawFeatures, prefix) => {
      return (rawFeatures || []).map((feature, idx) => ({
        ...feature,
        id: feature.id || `${prefix}-${idx + 1}`,
      }));
    };

    const slugify = (value) =>
      String(value || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");

    const map = new mapboxgl.Map({
      container: "costaMap",
      style,
      center: INITIAL_CENTER,
      zoom: INITIAL_ZOOM,
      cooperativeGestures: true,
      minZoom: 4,
      maxZoom: 18,
      attributionControl: false,
    });

    map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), "top-right");
    map.addControl(new mapboxgl.AttributionControl({ compact: true }), "bottom-right");

    const poiColors = {
      restaurant: "#f97316",
      hospital: "#ef4444",
      school: "#2563eb",
      pharmacy: "#16a34a",
      airport: "#0ea5e9",
      leisure: "#9333ea",
    };

    const poiIcons = {
      restaurant: "poi-restaurant",
      hospital: "poi-hospital",
      school: "poi-school",
      pharmacy: "poi-pharmacy",
      airport: "poi-airport",
      leisure: "poi-leisure",
    };

    let allPropertyFeatures = withStableId(featureCollection.features || [], "property").map((feature) => {
      const city = String(feature.properties?.city || "");
      const area = String(feature.properties?.area || city || "");
      const areaId = `${slugify(city)}::${slugify(area)}`;
      return {
        ...feature,
        properties: {
          ...(feature.properties || {}),
          area,
          city,
          areaId,
        },
      };
    });
    let allPoiFeatures = [];
    let zoneCollection = { type: "FeatureCollection", features: [] };
    const selectedZoneIds = new Set();
    let hoveredZoneFeatureId = null;
    let hoveredPropertyFeatureId = null;
    let selectedResultId = "";
    const activePoiCategories = new Set();
    let routeOrigin = null;
    let routeDestination = null;
    const selectedAreaIds = new Set();

    const getSelectedZoneFeatures = () => {
      if (!selectedZoneIds.size) return [];
      return zoneCollection.features.filter((feature) =>
        selectedZoneIds.has(String(feature.properties?.id || ""))
      );
    };

    const pointInsideSelectedZones = (pointCoords) => {
      const selectedZones = getSelectedZoneFeatures();
      if (!selectedZones.length) return true;
      return selectedZones.some((zoneFeature) =>
        booleanPointInPolygon(point(pointCoords), zoneFeature)
      );
    };

    const filterByZonesOnly = (featuresToFilter) => {
      if (!selectedZoneIds.size) {
        return { type: "FeatureCollection", features: featuresToFilter };
      }

      const filtered = featuresToFilter.filter((feature) => {
        const pointCoords = feature.geometry?.coordinates;
        if (!Array.isArray(pointCoords) || pointCoords.length < 2) return false;
        return pointInsideSelectedZones(pointCoords);
      });

      return { type: "FeatureCollection", features: filtered };
    };

    const filteredCollection = (featuresToFilter) => {
      const byZone = filterByZonesOnly(featuresToFilter).features;
      if (!selectedAreaIds.size) {
        return { type: "FeatureCollection", features: byZone };
      }
      return {
        type: "FeatureCollection",
        features: byZone.filter((feature) =>
          selectedAreaIds.has(String(feature.properties?.areaId || ""))
        ),
      };
    };
    const createPropertyPopupHtml = (props) => {
      const title = props.title || "Propiedad";
      const area = props.area || "";
      const city = props.city || "";
      const listingType = props.listingType || "unit";
      const availableUnits = props.availableUnits || "";
      const href = props.href || "#";
      const coverUrl = String(props.coverUrl || "").trim();
      const unitsLine = listingType === "promotion" && availableUnits ? `<p>${availableUnits} unidades disponibles</p>` : "";
      const lng = Number(props.lng ?? NaN);
      const lat = Number(props.lat ?? NaN);
      const media =
        coverUrl
          ? `<img class="map-popup-cover" src="${coverUrl}" alt="${title}" loading="lazy" decoding="async" />`
          : "";
      const routeButton =
        Number.isFinite(lng) && Number.isFinite(lat)
          ? `<button type="button" class="popup-start-route-btn" data-lng="${lng}" data-lat="${lat}" data-name="${title}">${routeStartLabel}</button>`
          : "";
      return `<div class="map-popup map-popup-property">${media}<div class="map-popup-body"><h3>${title}</h3><p>${city}${city && area ? " · " : ""}${area}</p>${unitsLine}<div class="map-popup-actions">${routeButton}<a href="${href}">Ver detalle</a></div></div></div>`;
    };

    const getVisiblePropertiesInViewport = () => {
      const bounds = map.getBounds();
      return filteredCollection(allPropertyFeatures).features.filter((feature) => {
        const [lng, lat] = feature.geometry?.coordinates || [];
        return bounds.contains([lng, lat]);
      });
    };

    const updateResultOpenState = () => {
      if (!(resultsListEl instanceof HTMLUListElement)) return;
      const ready = map.getZoom() >= DETAIL_ZOOM;
      resultsListEl.querySelectorAll(".map-result-item").forEach((item) => {
        const isSelected = item.getAttribute("data-id") === selectedResultId;
        item.classList.toggle("is-selected", isSelected);
        const link = item.querySelector(".result-open");
        if (link instanceof HTMLAnchorElement) {
          const allow = ready && isSelected;
          link.classList.toggle("is-ready", allow);
          link.setAttribute("aria-disabled", allow ? "false" : "true");
          link.tabIndex = allow ? 0 : -1;
        }
      });
    };

    const renderResultsPanel = () => {
      if (!(resultsListEl instanceof HTMLUListElement)) return;
      const visibleFeatures = getVisiblePropertiesInViewport();

      if (visibleFeatures.length === 0) {
        resultsListEl.innerHTML = `<li class="map-result-empty">Sin resultados visibles en este encuadre.</li>`;
        return;
      }

      const html = visibleFeatures
        .slice(0, 20)
        .map((feature) => {
          const props = feature.properties || {};
          const markerType = props.listingType === "promotion" ? "Proyecto" : "Vivienda";
          const coverUrl = String(props.coverUrl || "").trim();
          const mediaBlock = coverUrl
            ? `<div class="result-media"><img src="${coverUrl}" alt="${props.title || "Propiedad"}" loading="lazy" decoding="async" /></div>`
            : `<div class="result-media result-media-placeholder"></div>`;
          return `
            <li class="map-result-item" data-id="${feature.id}" data-lng="${feature.geometry.coordinates[0]}" data-lat="${feature.geometry.coordinates[1]}">
              ${mediaBlock}
              <div class="result-body">
                <button type="button" class="result-jump">${props.title || "Propiedad"}</button>
                <span>${props.city || ""}${props.city && props.area ? " · " : ""}${props.area || ""}</span>
                <span class="map-result-tag">${markerType}</span>
              </div>
              <div class="result-actions">
                <button type="button" class="result-route-btn" data-lng="${feature.geometry.coordinates[0]}" data-lat="${feature.geometry.coordinates[1]}" data-title="${props.title || "Propiedad"}">${routeStartLabel}</button>
                <a class="result-open" href="${props.href || "#"}" aria-disabled="true" tabindex="-1">${openDetailLabel}</a>
              </div>
            </li>
          `;
        })
        .join("");

      resultsListEl.innerHTML = html;
      updateResultOpenState();
    };

    const applyZoneFilterToSources = () => {
      const propertySource = map.getSource("properties");
      if (!propertySource) return;

      propertySource.setData(filteredCollection(allPropertyFeatures));
      updatePoiSourceData();
      renderResultsPanel();
      updateAreasSource();
    };

    const getPoiCollectionForMap = () => {
      let features = filterByZonesOnly(allPoiFeatures).features;
      if (selectedAreaIds.size) {
        features = features.filter((feature) => {
          const areaId = String(feature.properties?.areaId || "");
          // Many POIs come without area metadata; keep them visible instead of hiding everything.
          if (!areaId) return true;
          return selectedAreaIds.has(areaId);
        });
      }
      if (!selectedZoneIds.size && !selectedAreaIds.size) {
        const nearBounds = map.getBounds();
        features = features.filter((feature) => {
          const coords = feature.geometry?.coordinates || [];
          return Array.isArray(coords) && nearBounds.contains(coords);
        });
      }
      return { type: "FeatureCollection", features };
    };

    const updatePoiSourceData = () => {
      const poiSource = map.getSource("pois");
      if (!poiSource) return;
      poiSource.setData(getPoiCollectionForMap());
      poiFilters.forEach((filter) => {
        setPoiVisibility(filter.id, activePoiCategories.has(filter.id));
      });
    };

    const selectedZoneFilterExpression = () => {
      const zoneIds = [...selectedZoneIds];
      if (!zoneIds.length) return ["==", ["get", "id"], ""];
      return ["match", ["get", "id"], zoneIds, true, false];
    };

    const clearZoneSelection = () => {
      selectedZoneIds.clear();
      selectedAreaIds.clear();
      if (map.getLayer("zones-selected")) {
        map.setFilter("zones-selected", ["==", ["get", "id"], ""]);
      }
      zoneFiltersEl?.querySelectorAll(".zone-chip").forEach((chip) => {
        const chipZoneId = chip.getAttribute("data-zone-id") || "";
        chip.classList.toggle("is-active", chipZoneId === "");
      });
      applyZoneFilterToSources();
      updateZoneLayerVisibility();
      updateAreasSource();
      renderAreaChips();
    };

    const setZoneSelection = (zoneId, forceState = null) => {
      const normalized = String(zoneId || "");

      if (!normalized) {
        clearZoneSelection();
        return;
      }

      const shouldSelect = forceState === null ? !selectedZoneIds.has(normalized) : !!forceState;
      if (shouldSelect) selectedZoneIds.add(normalized);
      else selectedZoneIds.delete(normalized);
      selectedAreaIds.clear();

      if (map.getLayer("zones-selected")) {
        map.setFilter("zones-selected", selectedZoneFilterExpression());
      }

      zoneFiltersEl?.querySelectorAll(".zone-chip").forEach((chip) => {
        const chipZoneId = chip.getAttribute("data-zone-id") || "";
        if (!chipZoneId) {
          chip.classList.toggle("is-active", selectedZoneIds.size === 0);
        } else {
          chip.classList.toggle("is-active", selectedZoneIds.has(chipZoneId));
        }
      });

      applyZoneFilterToSources();
      updateZoneLayerVisibility();
      updateAreasSource();
      renderAreaChips();
    };

    const updateZoneLayerVisibility = () => {
      const insideDetailZoom = map.getZoom() >= ZONE_HIDE_ZOOM && selectedZoneIds.size > 0;
      const visibility = insideDetailZoom ? "none" : "visible";
      if (map.getLayer("zones-fill")) {
        map.setLayoutProperty("zones-fill", "visibility", visibility);
      }
      if (map.getLayer("zones-outline")) {
        map.setLayoutProperty("zones-outline", "visibility", visibility);
      }
      if (map.getLayer("zones-count")) {
        map.setLayoutProperty("zones-count", "visibility", visibility);
      }
    };

    const renderZoneChips = () => {
      if (!(zoneFiltersEl instanceof HTMLDivElement)) return;
      const allLabel = zoneFiltersEl.dataset.allLabel || "Sin filtro";
      const zones = zoneCollection.features
        .map((feature) => ({ id: String(feature.properties?.id || ""), name: String(feature.properties?.name || feature.properties?.id || "") }))
        .filter((zone) => zone.id)
        .sort((a, b) => a.name.localeCompare(b.name));

      zoneFiltersEl.innerHTML = [
        `<button type="button" class="zone-chip is-active" data-zone-id="">${allLabel}</button>`,
        ...zones.map((zone) => `<button type="button" class="zone-chip" data-zone-id="${zone.id}">${zone.name}</button>`),
      ].join("");

      zoneFiltersEl.querySelectorAll(".zone-chip").forEach((button) => {
        button.addEventListener("click", () => setZoneSelection(button.getAttribute("data-zone-id") || ""));
      });
    };

    const getFeaturesForAreaLevel = () => filteredCollection(allPropertyFeatures).features;

    const updateZoneCountsSource = () => {
      if (!map.getSource("zones")) return;
      const baseFeatures = zoneCollection.features || [];
      const props = allPropertyFeatures || [];
      const withCounts = baseFeatures.map((zoneFeature) => {
        const count = props.filter((propertyFeature) => {
          const coords = propertyFeature.geometry?.coordinates;
          if (!Array.isArray(coords) || coords.length < 2) return false;
          return booleanPointInPolygon(point(coords), zoneFeature);
        }).length;
        return {
          ...zoneFeature,
          properties: {
            ...(zoneFeature.properties || {}),
            propertyCount: count,
          },
        };
      });
      zoneCollection = { ...zoneCollection, features: withCounts };
      map.getSource("zones").setData(zoneCollection);
    };

    const computeAreaFeatures = () => {
      if (!selectedZoneIds.size || map.getZoom() < 10) {
        return { type: "FeatureCollection", features: [] };
      }

      const grouped = new Map();
      const current = filterByZonesOnly(allPropertyFeatures).features;
      for (const feature of current) {
        const props = feature.properties || {};
        const city = String(props.city || "");
        const area = String(props.area || city || "");
        const areaId = String(props.areaId || `${slugify(city)}::${slugify(area)}`);
        const key = areaId;
        if (!grouped.has(key)) {
          grouped.set(key, {
            areaId,
            city,
            area,
            count: 0,
            points: [],
          });
        }
        const entry = grouped.get(key);
        entry.count += 1;
        entry.points.push(feature.geometry.coordinates);
      }

      const features = [];
      for (const [key, entry] of grouped.entries()) {
        if (!entry.points.length) continue;
        const lngs = entry.points.map((p) => p[0]);
        const lats = entry.points.map((p) => p[1]);
        const minLng = Math.min(...lngs);
        const maxLng = Math.max(...lngs);
        const minLat = Math.min(...lats);
        const maxLat = Math.max(...lats);
        const centerLng = (minLng + maxLng) / 2;
        const centerLat = (minLat + maxLat) / 2;
        features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: [centerLng, centerLat] },
          properties: {
            id: key,
            areaId: entry.areaId,
            city: entry.city,
            area: entry.area,
            count: entry.count,
            minLng,
            maxLng,
            minLat,
            maxLat,
          },
        });
      }

      return { type: "FeatureCollection", features };
    };

    const updateAreasSource = () => {
      if (!map.getSource("areas")) return;
      map.getSource("areas").setData(computeAreaFeatures());
    };

    const renderAreaChips = () => {
      if (!(areaFiltersEl instanceof HTMLDivElement)) return;
      const allLabel = areaFiltersEl.dataset.allLabel || "Todas";
      const grouped = new Map();
      const current = filterByZonesOnly(allPropertyFeatures).features;
      for (const feature of current) {
        const props = feature.properties || {};
        const areaId = String(props.areaId || "");
        const area = String(props.area || "");
        if (!areaId || !area) continue;
        grouped.set(areaId, {
          areaId,
          area,
          count: (grouped.get(areaId)?.count || 0) + 1,
        });
      }

      const items = [...grouped.values()].sort((a, b) => a.area.localeCompare(b.area));
      areaFiltersEl.innerHTML = [
        `<button type="button" class="zone-chip ${selectedAreaIds.size === 0 ? "is-active" : ""}" data-area-id="">${allLabel}</button>`,
        ...items.map(
          (item) =>
            `<button type="button" class="zone-chip ${selectedAreaIds.has(item.areaId) ? "is-active" : ""}" data-area-id="${item.areaId}">${item.area} (${item.count})</button>`
        ),
      ].join("");

      areaFiltersEl.querySelectorAll(".zone-chip").forEach((button) => {
        button.addEventListener("click", () => {
          const areaId = button.getAttribute("data-area-id") || "";
          if (!areaId) {
            selectedAreaIds.clear();
          } else if (selectedAreaIds.has(areaId)) {
            selectedAreaIds.delete(areaId);
          } else {
            selectedAreaIds.add(areaId);
          }
          renderAreaChips();
          applyZoneFilterToSources();
          updateAreasSource();
        });
      });
    };

    const setPoiVisibility = (category, visible) => {
      const layerId = `pois-${category}`;
      const symbolLayerId = `pois-symbol-${category}`;
      if (map.getLayer(layerId)) map.setLayoutProperty(layerId, "visibility", visible ? "visible" : "none");
      if (map.getLayer(symbolLayerId)) map.setLayoutProperty(symbolLayerId, "visibility", visible ? "visible" : "none");
    };

    const registerPoiIcons = () => {
      const hexToRgb = (hex) => {
        const clean = String(hex || "").replace("#", "");
        if (clean.length !== 6) return { r: 107, g: 114, b: 128 };
        return {
          r: Number.parseInt(clean.slice(0, 2), 16),
          g: Number.parseInt(clean.slice(2, 4), 16),
          b: Number.parseInt(clean.slice(4, 6), 16),
        };
      };

      const tone = (hex, delta) => {
        const { r, g, b } = hexToRgb(hex);
        const clamp = (v) => Math.max(0, Math.min(255, Math.round(v)));
        return `rgb(${clamp(r + delta)}, ${clamp(g + delta)}, ${clamp(b + delta)})`;
      };

      const drawStar = (ctx, cx, cy, outerR, innerR) => {
        let rot = Math.PI / 2 * 3;
        const step = Math.PI / 5;
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerR);
        for (let i = 0; i < 5; i += 1) {
          ctx.lineTo(cx + Math.cos(rot) * outerR, cy + Math.sin(rot) * outerR);
          rot += step;
          ctx.lineTo(cx + Math.cos(rot) * innerR, cy + Math.sin(rot) * innerR);
          rot += step;
        }
        ctx.closePath();
      };

      const drawPill = (ctx, cx, cy, width, height, angle = -0.62) => {
        const radius = height / 2;
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);
        ctx.beginPath();
        ctx.moveTo(-width / 2 + radius, -height / 2);
        ctx.lineTo(width / 2 - radius, -height / 2);
        ctx.arc(width / 2 - radius, 0, radius, -Math.PI / 2, Math.PI / 2);
        ctx.lineTo(-width / 2 + radius, height / 2);
        ctx.arc(-width / 2 + radius, 0, radius, Math.PI / 2, Math.PI * 1.5);
        ctx.closePath();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, -height / 2 + 0.6);
        ctx.lineTo(0, height / 2 - 0.6);
        ctx.stroke();
        ctx.restore();
      };

      const drawPoiGlyph = (ctx, category, cx, cy) => {
        ctx.save();
        ctx.strokeStyle = "#ffffff";
        ctx.fillStyle = "#ffffff";
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        if (category === "restaurant") {
          ctx.lineWidth = 2.8;
          ctx.beginPath();
          ctx.moveTo(cx - 8, cy - 10);
          ctx.lineTo(cx - 8, cy + 9);
          ctx.moveTo(cx - 12, cy - 10);
          ctx.lineTo(cx - 12, cy - 4);
          ctx.moveTo(cx - 8, cy - 10);
          ctx.lineTo(cx - 8, cy - 4);
          ctx.moveTo(cx - 4, cy - 10);
          ctx.lineTo(cx - 4, cy - 4);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(cx + 9, cy - 10);
          ctx.lineTo(cx + 3, cy + 9);
          ctx.lineTo(cx + 10.5, cy + 9);
          ctx.closePath();
          ctx.fill();
        } else if (category === "hospital") {
          ctx.lineWidth = 4.6;
          ctx.beginPath();
          ctx.moveTo(cx - 9, cy);
          ctx.lineTo(cx + 9, cy);
          ctx.moveTo(cx, cy - 9);
          ctx.lineTo(cx, cy + 9);
          ctx.stroke();
        } else if (category === "school") {
          ctx.beginPath();
          ctx.moveTo(cx - 13, cy - 2);
          ctx.lineTo(cx, cy - 9);
          ctx.lineTo(cx + 13, cy - 2);
          ctx.lineTo(cx, cy + 5);
          ctx.closePath();
          ctx.fill();

          ctx.fillRect(cx - 8, cy + 5, 16, 3.4);
          ctx.lineWidth = 2.2;
          ctx.beginPath();
          ctx.moveTo(cx + 10, cy - 1);
          ctx.lineTo(cx + 12, cy + 9);
          ctx.stroke();
        } else if (category === "pharmacy") {
          ctx.lineWidth = 2.8;
          drawPill(ctx, cx, cy + 1, 21, 9);
        } else if (category === "airport") {
          ctx.lineWidth = 2.6;
          ctx.beginPath();
          ctx.moveTo(cx - 12, cy);
          ctx.lineTo(cx + 12, cy);
          ctx.moveTo(cx, cy - 9);
          ctx.lineTo(cx, cy + 10);
          ctx.moveTo(cx - 8, cy - 6);
          ctx.lineTo(cx, cy - 1.5);
          ctx.lineTo(cx + 8, cy - 6);
          ctx.moveTo(cx - 7, cy + 6);
          ctx.lineTo(cx, cy + 2.4);
          ctx.lineTo(cx + 7, cy + 6);
          ctx.stroke();
        } else {
          drawStar(ctx, cx, cy, 10.5, 5.2);
          ctx.fill();
        }

        ctx.restore();
      };

      Object.entries(poiIcons).forEach(([category, imageId]) => {
        if (map.hasImage(imageId)) return;
        const size = 64;
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        ctx.clearRect(0, 0, size, size);
        ctx.beginPath();
        ctx.arc(size / 2, size / 2 + 2.2, 22, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(15, 23, 42, 0.34)";
        ctx.fill();

        const baseColor = poiColors[category] || "#6b7280";
        const radial = ctx.createLinearGradient(12, 10, 52, 56);
        radial.addColorStop(0, tone(baseColor, 32));
        radial.addColorStop(0.52, baseColor);
        radial.addColorStop(1, tone(baseColor, -28));

        ctx.beginPath();
        ctx.arc(size / 2, size / 2, 23, 0, Math.PI * 2);
        ctx.fillStyle = radial;
        ctx.fill();

        ctx.beginPath();
        ctx.arc(size / 2, size / 2, 22, 0, Math.PI * 2);
        ctx.lineWidth = 3.2;
        ctx.strokeStyle = "#ffffff";
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(size / 2 - 5, size / 2 - 7, 10.5, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
        ctx.fill();

        drawPoiGlyph(ctx, category, size / 2, size / 2);

        map.addImage(imageId, ctx.getImageData(0, 0, size, size), { pixelRatio: 2 });
      });
    };

    const routePointsFeatureCollection = () => {
      const points = [];
      if (routeOrigin) {
        points.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: routeOrigin },
          properties: { role: "origin" },
        });
      }
      if (routeDestination) {
        points.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: routeDestination },
          properties: { role: "destination" },
        });
      }
      return { type: "FeatureCollection", features: points };
    };

    const updateRoutePointLayers = () => {
      map.getSource("route-points")?.setData(routePointsFeatureCollection());
    };

    const updateRouteOverlayVisibility = () => {
      if (!(routeOverlay instanceof HTMLElement)) return;
      const show = !!routeOrigin;
      if (show) routeOverlay.removeAttribute("hidden");
      else routeOverlay.setAttribute("hidden", "");
    };

    const clearRoute = () => {
      routeOrigin = null;
      routeDestination = null;
      map.getSource("route")?.setData({ type: "FeatureCollection", features: [] });
      map.getSource("route-points")?.setData({ type: "FeatureCollection", features: [] });
      if (routeMetrics instanceof HTMLDivElement) routeMetrics.hidden = true;
      if (routeDistanceValue instanceof HTMLSpanElement) routeDistanceValue.textContent = "";
      if (routeDurationValue instanceof HTMLSpanElement) routeDurationValue.textContent = "";
      if (routeSelectionState instanceof HTMLParagraphElement) {
        routeSelectionState.textContent = "Selecciona una vivienda para comenzar la ruta.";
      }
      updateRouteOverlayVisibility();
    };

    const setRouteOrigin = (coords, label = "") => {
      routeOrigin = coords;
      routeDestination = null;
      map.getSource("route")?.setData({ type: "FeatureCollection", features: [] });
      if (routeMetrics instanceof HTMLDivElement) routeMetrics.hidden = true;
      if (routeDistanceValue instanceof HTMLSpanElement) routeDistanceValue.textContent = "";
      if (routeDurationValue instanceof HTMLSpanElement) routeDurationValue.textContent = "";
      updateRoutePointLayers();
      updateRouteOverlayVisibility();
      if (routeSelectionState instanceof HTMLParagraphElement) {
        routeSelectionState.textContent = label
          ? `Ruta iniciada desde: ${label}. ¿A donde quieres ir? Elige restaurante, hospital, colegio, farmacia, aeropuerto u ocio.`
          : "Ruta iniciada. ¿A donde quieres ir? Elige destino en POIs o en la lista.";
      }
    };

    const setRouteDestination = async (coords, label = "") => {
      if (!routeOrigin) return;
      routeDestination = coords;
      updateRoutePointLayers();
      updateRouteOverlayVisibility();
      await drawRoute();
      if (routeSelectionState instanceof HTMLParagraphElement) {
        routeSelectionState.textContent = label
          ? `Destino fijado: ${label}.`
          : "Destino fijado.";
      }
    };

    const drawRoute = async () => {
      if (!routeOrigin || !routeDestination) return;
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${routeOrigin[0]},${routeOrigin[1]};${routeDestination[0]},${routeDestination[1]}?geometries=geojson&overview=full&steps=false&access_token=${token}`;
      try {
        const response = await fetch(url);
        if (!response.ok) return;
        const data = await response.json();
        const first = data.routes?.[0];
        if (!first?.geometry) return;

        map.getSource("route")?.setData({
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              geometry: first.geometry,
              properties: {},
            },
          ],
        });

        const km = (Number(first.distance || 0) / 1000).toFixed(2);
        const minutes = Math.round(Number(first.duration || 0) / 60);
        if (routeDistanceValue instanceof HTMLSpanElement) routeDistanceValue.textContent = `${km} km`;
        if (routeDurationValue instanceof HTMLSpanElement) routeDurationValue.textContent = `${minutes} min`;
        if (routeMetrics instanceof HTMLDivElement) routeMetrics.hidden = false;
      } catch {
        // Ignore API errors
      }
    };
    map.on("load", async () => {
      registerPoiIcons();

      map.addSource("properties", {
        type: "geojson",
        data: { type: "FeatureCollection", features: allPropertyFeatures },
        cluster: true,
        clusterRadius: 46,
        clusterMaxZoom: 12,
      });

      map.addSource("pois", {
        type: "geojson",
        data: { type: "FeatureCollection", features: [] },
      });

      map.addSource("route", {
        type: "geojson",
        data: { type: "FeatureCollection", features: [] },
      });

      map.addSource("route-points", {
        type: "geojson",
        data: { type: "FeatureCollection", features: [] },
      });

      map.addSource("areas", {
        type: "geojson",
        data: { type: "FeatureCollection", features: [] },
      });

      map.addLayer({
        id: "clusters",
        type: "circle",
        source: "properties",
        filter: ["has", "point_count"],
        paint: {
          "circle-color": "#202F4E",
          "circle-radius": ["step", ["get", "point_count"], 16, 12, 20, 24, 24],
          "circle-stroke-color": "#ffffff",
          "circle-stroke-width": 2,
        },
      });

      map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "properties",
        filter: ["has", "point_count"],
        layout: {
          "text-field": "{point_count_abbreviated}",
          "text-size": 12,
          "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
        },
        paint: {
          "text-color": "#ffffff",
        },
      });

      map.addLayer({
        id: "points",
        type: "circle",
        source: "properties",
        filter: ["!", ["has", "point_count"]],
        paint: {
          "circle-color": ["match", ["get", "listingType"], "promotion", "#1d4ed8", "#D32C43"],
          "circle-radius": ["case", ["boolean", ["feature-state", "hover"], false], 10, ["match", ["get", "listingType"], "promotion", 8, 6]],
          "circle-stroke-color": "#ffffff",
          "circle-stroke-width": 2,
        },
      });

      map.addLayer({
        id: "route-line",
        type: "line",
        source: "route",
        paint: {
          "line-color": "#0f766e",
          "line-width": 4,
          "line-opacity": 0.9,
        },
      });

      map.addLayer({
        id: "route-points-layer",
        type: "circle",
        source: "route-points",
        paint: {
          "circle-color": [
            "match",
            ["get", "role"],
            "origin",
            "#0ea5e9",
            "destination",
            "#d32c43",
            "#202f4e",
          ],
          "circle-radius": 7,
          "circle-stroke-color": "#ffffff",
          "circle-stroke-width": 2,
        },
      });

      map.addLayer({
        id: "areas-bubbles",
        type: "circle",
        source: "areas",
        paint: {
          "circle-color": "#1d4ed8",
          "circle-radius": [
            "interpolate",
            ["linear"],
            ["get", "count"],
            1,
            12,
            5,
            16,
            12,
            21,
          ],
          "circle-opacity": 0.82,
          "circle-stroke-color": "#ffffff",
          "circle-stroke-width": 2,
        },
      });

      map.addLayer({
        id: "areas-count",
        type: "symbol",
        source: "areas",
        layout: {
          "text-field": ["concat", ["get", "area"], "\n", ["to-string", ["get", "count"]]],
          "text-size": 11,
          "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
          "text-max-width": 9,
          "text-justify": "center",
        },
        paint: {
          "text-color": "#ffffff",
          "text-halo-color": "rgba(15,23,42,0.35)",
          "text-halo-width": 0.8,
        },
      });

      map.on("click", "clusters", (event) => {
        const feature = map.queryRenderedFeatures(event.point, { layers: ["clusters"] })[0];
        if (!feature) return;
        const clusterId = feature.properties?.cluster_id;
        map.getSource("properties").getClusterExpansionZoom(clusterId, (error, zoom) => {
          if (error) return;
          map.easeTo({ center: feature.geometry.coordinates, zoom });
        });
      });

      map.on("mousemove", "points", (event) => {
        map.getCanvas().style.cursor = "pointer";
        const current = event.features?.[0];
        if (!current || current.id == null) return;
        if (hoveredPropertyFeatureId !== null && hoveredPropertyFeatureId !== current.id) {
          map.setFeatureState({ source: "properties", id: hoveredPropertyFeatureId }, { hover: false });
        }
        hoveredPropertyFeatureId = current.id;
        map.setFeatureState({ source: "properties", id: hoveredPropertyFeatureId }, { hover: true });
      });

      map.on("mouseleave", "points", () => {
        map.getCanvas().style.cursor = "";
        if (hoveredPropertyFeatureId !== null) {
          map.setFeatureState({ source: "properties", id: hoveredPropertyFeatureId }, { hover: false });
        }
        hoveredPropertyFeatureId = null;
      });

      map.on("click", "points", (event) => {
        const pointFeature = event.features?.[0];
        if (!pointFeature) return;
        const id = String(pointFeature.id || "");
        selectedResultId = id;
        updateResultOpenState();
        const coords = pointFeature.geometry.coordinates.slice();
        map.flyTo({
          center: coords,
          zoom: Math.max(map.getZoom(), PROPERTY_FOCUS_ZOOM),
          duration: 850,
          essential: true,
        });
        const popupProps = {
          ...(pointFeature.properties || {}),
          lng: coords[0],
          lat: coords[1],
        };
        new mapboxgl.Popup({ closeButton: true, offset: 12 })
          .setLngLat(coords)
          .setHTML(createPropertyPopupHtml(popupProps))
          .addTo(map);
      });

      map.on("click", "areas-bubbles", (event) => {
        const areaFeature = event.features?.[0];
        if (!areaFeature) return;
        const p = areaFeature.properties || {};
        const areaId = String(p.areaId || p.id || "");
        if (areaId) {
          if (selectedAreaIds.has(areaId)) selectedAreaIds.delete(areaId);
          else selectedAreaIds.add(areaId);
          renderAreaChips();
          applyZoneFilterToSources();
        }
        const minLng = Number(p.minLng);
        const minLat = Number(p.minLat);
        const maxLng = Number(p.maxLng);
        const maxLat = Number(p.maxLat);
        if ([minLng, minLat, maxLng, maxLat].every(Number.isFinite)) {
          map.fitBounds(
            [
              [minLng, minLat],
              [maxLng, maxLat],
            ],
            { padding: 55, duration: 700, maxZoom: 16.2 }
          );
        }
      });

      map.on("mouseenter", "areas-bubbles", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "areas-bubbles", () => {
        map.getCanvas().style.cursor = "";
      });

      map.on("click", (event) => {
        if (selectedZoneIds.size) {
          const candidateLayers = ["zones-fill", "zones-outline", "zones-selected", "areas-bubbles", "points", "clusters"];
          const existingLayers = candidateLayers.filter((layerId) => map.getLayer(layerId));
          const hits = existingLayers.length
            ? map.queryRenderedFeatures(event.point, { layers: existingLayers })
            : [];
          if (!hits.length) {
            clearZoneSelection();
            updateAreasSource();
          }
        }
      });

      try {
        const zonesResponse = await fetch(zonesUrl);
        if (zonesResponse.ok) {
          const rawZones = await zonesResponse.json();
          const normalized = (rawZones.features || []).map((feature, index) => ({
            ...feature,
            id: index + 1,
            properties: {
              ...(feature.properties || {}),
              id: String(feature.properties?.id || `zone-${index + 1}`),
              name: String(feature.properties?.name || feature.properties?.id || `zone-${index + 1}`),
            },
          }));

          zoneCollection = { type: "FeatureCollection", features: normalized };
          map.addSource("zones", { type: "geojson", data: zoneCollection });
          map.addLayer({ id: "zones-fill", type: "fill", source: "zones", paint: { "fill-color": "#2563eb", "fill-opacity": ["case", ["boolean", ["feature-state", "hover"], false], 0.22, 0.08] } });
          map.addLayer({ id: "zones-outline", type: "line", source: "zones", paint: { "line-color": "#1d4ed8", "line-width": 1 } });
          map.addLayer({ id: "zones-selected", type: "line", source: "zones", filter: ["==", ["get", "id"], ""], paint: { "line-color": "#D32C43", "line-width": 3 } });
          map.addLayer({
            id: "zones-count",
            type: "symbol",
            source: "zones",
            layout: {
              "text-field": [
                "case",
                [">", ["coalesce", ["get", "propertyCount"], 0], 0],
                ["to-string", ["get", "propertyCount"]],
                "",
              ],
              "text-size": 13,
              "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
            },
            paint: {
              "text-color": "#0f172a",
              "text-halo-color": "#ffffff",
              "text-halo-width": 1.4,
            },
          });

          map.on("mousemove", "zones-fill", (event) => {
            const feature = event.features?.[0];
            if (!feature) return;
            if (hoveredZoneFeatureId !== null) map.setFeatureState({ source: "zones", id: hoveredZoneFeatureId }, { hover: false });
            hoveredZoneFeatureId = feature.id;
            map.setFeatureState({ source: "zones", id: hoveredZoneFeatureId }, { hover: true });
          });

          map.on("mouseleave", "zones-fill", () => {
            if (hoveredZoneFeatureId !== null) map.setFeatureState({ source: "zones", id: hoveredZoneFeatureId }, { hover: false });
            hoveredZoneFeatureId = null;
          });

          map.on("click", "zones-fill", (event) => {
            const feature = event.features?.[0];
            if (!feature) return;
            const zoneId = String(feature.properties?.id || "");
            const wasSelected = selectedZoneIds.has(zoneId);
            setZoneSelection(zoneId);
            if (wasSelected) return;
            const bounds = new mapboxgl.LngLatBounds();
            const geometry = feature.geometry;
            if (geometry?.type === "Polygon") {
              geometry.coordinates?.[0]?.forEach((coord) => bounds.extend(coord));
            } else if (geometry?.type === "MultiPolygon") {
              geometry.coordinates?.forEach((polygon) =>
                polygon?.[0]?.forEach((coord) => bounds.extend(coord))
              );
            }
          if (!bounds.isEmpty()) {
              map.fitBounds(bounds, { padding: 55, duration: 700, maxZoom: 11.8 });
            }
          });

          renderZoneChips();
          renderAreaChips();
          updateZoneCountsSource();
          updateAreasSource();
          updateZoneLayerVisibility();
        }
      } catch {
        // Continue without zones
      }

      try {
        const response = await fetch(poisUrl);
        if (response.ok) {
          const pois = await response.json();
          const airportFeatures = [
            {
              type: "Feature",
              geometry: { type: "Point", coordinates: [-4.49911, 36.675] },
              properties: {
                id: "manual-airport-malaga",
                name: "Aeropuerto de Malaga (AGP)",
                category: "airport",
                city: "Malaga",
                area: "Churriana",
                address: "Av. del Comandante Garcia Morato, s/n",
              },
            },
            {
              type: "Feature",
              geometry: { type: "Point", coordinates: [-5.34968, 36.15122] },
              properties: {
                id: "manual-airport-gibraltar",
                name: "Aeropuerto de Gibraltar (GIB)",
                category: "airport",
                city: "Gibraltar",
                area: "",
                address: "Winston Churchill Ave",
              },
            },
          ];

          allPoiFeatures = withStableId([...(pois.features || []), ...airportFeatures], "poi").map((feature) => {
            const props = feature.properties || {};
            const city = String(props.city || "");
            const area = String(props.area || "");
            const areaId =
              city && area
                ? `${slugify(city)}::${slugify(area)}`
                : "";
            return {
              ...feature,
              properties: {
                ...props,
                city,
                area,
                areaId,
              },
            };
          });

          poiFilters.forEach((filter) => {
            const layerId = `pois-${filter.id}`;
            const symbolLayerId = `pois-symbol-${filter.id}`;
            map.addLayer({
              id: layerId,
              type: "circle",
              source: "pois",
              filter: ["==", ["get", "category"], filter.id],
              layout: { visibility: "none" },
              paint: {
                "circle-color": poiColors[filter.id] || "#6b7280",
                "circle-radius": 5,
                "circle-stroke-color": "#ffffff",
                "circle-stroke-width": 1.2,
              },
            });

            map.addLayer({
              id: symbolLayerId,
              type: "symbol",
              source: "pois",
              filter: ["==", ["get", "category"], filter.id],
              layout: {
                visibility: "none",
                "icon-image": poiIcons[filter.id] || "marker-15",
                "icon-size": 0.62,
                "icon-padding": 8,
                "icon-allow-overlap": false,
                "icon-ignore-placement": false,
              },
            });

            const handlePoiClick = (event) => {
              const poi = event.features?.[0];
              if (!poi) return;
              const props = poi.properties || {};
              if (routeOrigin) {
                setRouteDestination(poi.geometry.coordinates.slice(), props.name || "POI");
              }
              const html = `<div class="map-popup"><div class="map-popup-body"><h3>${props.name || "POI"}</h3><p>${props.city || ""}${props.city && props.area ? " · " : ""}${props.area || ""}</p>${props.address ? `<p>${props.address}</p>` : ""}</div></div>`;
              new mapboxgl.Popup({ closeButton: true, offset: 10 })
                .setLngLat(poi.geometry.coordinates.slice())
                .setHTML(html)
                .addTo(map);
            };

            map.on("click", layerId, handlePoiClick);
            map.on("click", symbolLayerId, handlePoiClick);
          });

          poiFiltersEl?.querySelectorAll(".poi-chip[data-category]").forEach((button) => {
            button.addEventListener("click", () => {
              const category = button.getAttribute("data-category");
              if (!category) return;
              if (activePoiCategories.has(category)) {
                activePoiCategories.delete(category);
                button.classList.remove("is-active");
                setPoiVisibility(category, false);
              } else {
                activePoiCategories.add(category);
                button.classList.add("is-active");
                setPoiVisibility(category, true);
              }
              poiFilters.forEach((filter) => {
                setPoiVisibility(filter.id, activePoiCategories.has(filter.id));
              });
              updatePoiSourceData();
            });
          });

          applyZoneFilterToSources();
          renderResultsPanel();
          map.on("moveend", renderResultsPanel);
        }
      } catch {
        // Continue without pois
      }

    });

    map.on("moveend", () => {
      updateResultOpenState();
      updateZoneLayerVisibility();
      updateAreasSource();
      updatePoiSourceData();
    });

    resultsListEl?.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      const link = target.closest(".result-open");
      if (link instanceof HTMLAnchorElement && !link.classList.contains("is-ready")) {
        event.preventDefault();
        return;
      }

      const item = target.closest(".map-result-item");
      if (!(item instanceof HTMLLIElement)) return;

      if (target.closest(".result-open")) return;
      const routeBtn = target.closest(".result-route-btn");
      if (routeBtn instanceof HTMLButtonElement) {
        const routeLng = Number(routeBtn.dataset.lng);
        const routeLat = Number(routeBtn.dataset.lat);
        const routeTitle = routeBtn.dataset.title || "Propiedad";
        if (Number.isFinite(routeLng) && Number.isFinite(routeLat)) {
          setRouteOrigin([routeLng, routeLat], routeTitle);
        }
        return;
      }

      const lng = Number(item.dataset.lng);
      const lat = Number(item.dataset.lat);
      const id = item.dataset.id || "";
      if (!Number.isFinite(lng) || !Number.isFinite(lat)) return;

      selectedResultId = id;
      map.flyTo({
        center: [lng, lat],
        zoom: Math.max(map.getZoom(), PROPERTY_FOCUS_ZOOM),
        duration: 850,
        essential: true,
      });
      updateResultOpenState();
    });

    routeClearBtn?.addEventListener("click", () => {
      clearRoute();
    });

    resetViewBtn?.addEventListener("click", () => {
      map.easeTo({
        center: INITIAL_CENTER,
        zoom: INITIAL_ZOOM,
        bearing: 0,
        pitch: 0,
        duration: 850,
        essential: true,
      });
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const startButton = target.closest(".popup-start-route-btn");
      if (startButton instanceof HTMLButtonElement) {
        const startLng = Number(startButton.dataset.lng);
        const startLat = Number(startButton.dataset.lat);
        const startName = startButton.dataset.name || "Propiedad";
        if (Number.isFinite(startLng) && Number.isFinite(startLat)) {
          setRouteOrigin([startLng, startLat], startName);
        }
        return;
      }
    });
  }
</script>

<style>
  .map-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 400px;
    gap: 0.8rem;
    padding: 0.25rem 0 1.5rem;
  }

  .map-main {
    min-width: 0;
    position: relative;
  }

  .map-reset-wrap {
    position: absolute;
    top: 0.85rem;
    right: 4.2rem;
    z-index: 5;
    pointer-events: none;
  }

  .map-reset-view-btn {
    pointer-events: auto;
    box-shadow: 0 8px 14px rgba(15, 23, 42, 0.16);
    backdrop-filter: blur(3px);
    background: rgba(255, 255, 255, 0.92);
  }

  .map-route-overlay {
    position: absolute;
    top: 3.9rem;
    right: 0.85rem;
    z-index: 5;
    width: min(320px, calc(100% - 1.7rem));
    display: grid;
    gap: 0.44rem;
    padding: 0.62rem 0.72rem;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.38);
    background: linear-gradient(145deg, rgba(15, 23, 42, 0.52), rgba(30, 41, 59, 0.4));
    backdrop-filter: blur(4px);
    pointer-events: none;
  }

  .map-route-overlay[hidden] {
    display: none;
  }

  .map-route-overlay-title {
    margin: 0;
    color: #ffffff;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 900;
    text-shadow: 0 2px 7px rgba(0, 0, 0, 0.42);
    font-family: "Manrope", sans-serif;
  }

  .map-route-clear-btn {
    width: fit-content;
    pointer-events: auto;
  }

  .route-selection-overlay {
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.77rem;
    line-height: 1.3;
    text-shadow: 0 2px 9px rgba(0, 0, 0, 0.42);
  }

  .route-metrics-overlay {
    pointer-events: auto;
    border-color: rgba(255, 255, 255, 0.24);
    background: rgba(15, 23, 42, 0.28);
  }

  .route-metrics-overlay p {
    color: #ffffff;
    font-size: 0.78rem;
  }

  .route-metrics-overlay strong,
  .route-metrics-overlay span {
    color: #ffffff;
  }

  .map-route-overlay .route-selection,
  .map-route-overlay .route-selection-overlay {
    color: #ffffff !important;
  }

  .map-route-overlay .route-metrics p,
  .map-route-overlay .route-metrics strong,
  .map-route-overlay .route-metrics span {
    color: #ffffff !important;
  }

  .costa-map {
    width: 100%;
    height: min(80vh, 820px);
    min-height: 560px;
    border-radius: 18px;
    border: 1px solid rgba(32, 47, 78, 0.14);
    overflow: hidden;
    background: #e9eef5;
  }

  .map-nav {
    display: grid;
    gap: 0.55rem;
    align-content: start;
    position: sticky;
    top: 5rem;
    max-height: calc(100vh - 6rem);
    overflow: auto;
    padding-right: 0.2rem;
  }

  .nav-section {
    background: #fff;
    border: 1px solid rgba(32, 47, 78, 0.12);
    border-radius: 16px;
    padding: 0.75rem 0.8rem;
    position: relative;
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
  }

  .nav-section[data-step]::before {
    content: attr(data-step);
    position: absolute;
    top: 0.6rem;
    right: 0.65rem;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 999px;
    background: rgba(32, 47, 78, 0.1);
    color: #202f4e;
    font-size: 0.65rem;
    font-weight: 800;
    display: grid;
    place-items: center;
    font-family: "Manrope", sans-serif;
  }

  .map-action {
    border: 0;
    background: linear-gradient(135deg, #202f4e, #1d4ed8);
    color: #fff;
    padding: 0.55rem 0.9rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
  }

  .map-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 14px rgba(32, 47, 78, 0.24);
  }

  .map-action-alt {
    background: #fff;
    color: #202f4e;
    border: 1px solid rgba(32, 47, 78, 0.18);
  }

  .map-action.is-active,
  .map-action-alt.is-active {
    background: #d32c43;
    color: #fff;
    border-color: #d32c43;
  }

  .map-filter-title {
    margin: 0 0 0.3rem;
    color: #202f4e;
    font-size: 0.66rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-family: "Manrope", sans-serif;
  }

  .zone-filters,
  .poi-filters,
  .travel-mode,
  .travel-minutes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .zone-chip,
  :global(#zoneFilters .zone-chip),
  :global(#areaFilters .zone-chip),
  .poi-chip {
    border: 1px solid rgba(32, 47, 78, 0.16);
    background: linear-gradient(180deg, #ffffff, #f5f7fb);
    color: #202f4e;
    padding: 0.36rem 0.64rem;
    border-radius: 999px;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
    line-height: 1;
    min-height: 1.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
    transition:
      transform 0.16s ease,
      box-shadow 0.16s ease,
      background-color 0.16s ease,
      border-color 0.16s ease,
      color 0.16s ease;
  }

  .zone-chip:hover,
  :global(#zoneFilters .zone-chip:hover),
  :global(#areaFilters .zone-chip:hover),
  .poi-chip:hover,
  .zone-chip:focus-visible,
  :global(#zoneFilters .zone-chip:focus-visible),
  :global(#areaFilters .zone-chip:focus-visible),
  .poi-chip:focus-visible {
    border-color: rgba(32, 47, 78, 0.28);
    background: #fff;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
    transform: translateY(-1px);
    outline: none;
  }

  .zone-chip.is-active,
  :global(#zoneFilters .zone-chip.is-active),
  :global(#areaFilters .zone-chip.is-active),
  .poi-chip.is-active {
    background: #202f4e;
    color: #fff;
    border-color: #202f4e;
    box-shadow: 0 8px 16px rgba(32, 47, 78, 0.24);
  }

  .travel-box {
    display: grid;
    gap: 0.45rem;
  }

  .quick-route-box {
    display: grid;
    gap: 0.3rem;
    padding: 0.45rem 0.5rem;
    border: 1px solid rgba(32, 47, 78, 0.12);
    border-radius: 10px;
    background: rgba(32, 47, 78, 0.03);
  }

  .quick-route-title {
    margin: 0;
    font-size: 0.72rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #202f4e;
    font-family: "Manrope", sans-serif;
  }

  .quick-route-hint {
    margin: 0;
    font-size: 0.75rem;
    color: rgba(32, 47, 78, 0.78);
    font-family: "Manrope", sans-serif;
  }

  .travel-hint {
    margin: 0;
    font-size: 0.76rem;
    color: rgba(32, 47, 78, 0.76);
    font-family: "Manrope", sans-serif;
  }

  .route-selection {
    margin: 0;
    font-size: 0.78rem;
    color: rgba(32, 47, 78, 0.72);
    font-family: "Manrope", sans-serif;
  }

  .route-metrics {
    display: grid;
    gap: 0.2rem;
    padding: 0.45rem 0.55rem;
    border: 1px solid rgba(32, 47, 78, 0.12);
    border-radius: 10px;
    background: rgba(32, 47, 78, 0.03);
  }

  .route-metrics p {
    margin: 0;
    font-size: 0.8rem;
    color: #202f4e;
    font-family: "Manrope", sans-serif;
  }

  .route-manual-controls[hidden] {
    display: none;
  }

  .travel-minutes-title {
    margin: 0.2rem 0 0;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(32, 47, 78, 0.7);
    font-weight: 800;
    font-family: "Manrope", sans-serif;
  }

  .map-nav h3 {
    margin: 0.45rem 0 0;
    font-size: 1rem;
    color: #202f4e;
    font-family: "Manrope", sans-serif;
  }

  .map-result-list {
    list-style: none;
    margin: 0.7rem 0 0;
    padding: 0;
    display: grid;
    gap: 0.6rem;
    max-height: 500px;
    overflow: auto;
  }

  .map-result-item {
    border: 1px solid rgba(32, 47, 78, 0.11);
    border-radius: 13px;
    padding: 0.66rem;
    display: grid;
    grid-template-columns: 86px minmax(0, 1fr);
    gap: 0.38rem 0.55rem;
    background: linear-gradient(180deg, #ffffff, #fbfcff);
    box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
    transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease;
  }

  .map-result-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 22px rgba(15, 23, 42, 0.11);
    border-color: rgba(32, 47, 78, 0.2);
  }

  .map-result-item.is-selected {
    border-color: rgba(211, 44, 67, 0.35);
    background: rgba(211, 44, 67, 0.04);
  }

  .result-jump {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    border: 0;
    padding: 0;
    margin: 0;
    text-align: left;
    color: #202f4e;
    font-size: 0.92rem;
    font-weight: 800;
    background: transparent;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
    line-height: 1.25;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .result-jump:hover {
    color: #1d4ed8;
  }

  .result-body > span:not(.map-result-tag) {
    color: rgba(32, 47, 78, 0.75);
    font-size: 0.79rem;
    line-height: 1.3;
    font-family: "Manrope", sans-serif;
  }

  .result-media {
    width: 86px;
    height: 86px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(32, 47, 78, 0.12);
    background: #e6edf7;
    grid-row: span 2;
  }

  .result-media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .result-media-placeholder {
    background:
      linear-gradient(135deg, rgba(32, 47, 78, 0.14), rgba(211, 44, 67, 0.18)),
      repeating-linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.12),
        rgba(255, 255, 255, 0.12) 8px,
        rgba(255, 255, 255, 0.04) 8px,
        rgba(255, 255, 255, 0.04) 16px
      );
  }

  .result-body {
    min-width: 0;
    display: grid;
    gap: 0.18rem;
    align-content: start;
  }

  .map-result-tag {
    display: inline-flex;
    width: fit-content;
    border: 1px solid rgba(32, 47, 78, 0.16);
    border-radius: 999px;
    padding: 0.16rem 0.5rem;
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: #202f4e;
    background: rgba(32, 47, 78, 0.06);
  }

  .result-open {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    display: inline-flex;
    width: fit-content;
    margin-top: 0;
    align-items: center;
    justify-content: center;
    min-height: 30px;
    padding: 0.3rem 0.68rem;
    border-radius: 999px;
    border: 1px solid rgba(32, 47, 78, 0.16);
    color: rgba(32, 47, 78, 0.5);
    background: #f8fafc;
    text-decoration: none;
    pointer-events: none;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    font-family: "Manrope", sans-serif;
    transition: all 0.16s ease;
  }

  .result-open.is-ready {
    color: #fff;
    background: linear-gradient(135deg, #202f4e, #1d4ed8);
    border-color: transparent;
    pointer-events: auto;
  }

  .map-result-empty {
    font-size: 0.82rem;
    color: rgba(32, 47, 78, 0.75);
    padding: 0.5rem 0.2rem;
    font-family: "Manrope", sans-serif;
  }

  .map-empty {
    display: grid;
    place-items: center;
    height: 100%;
    color: #202f4e;
    padding: 1rem;
    text-align: center;
    font-family: "Manrope", sans-serif;
  }

  :global(.mapboxgl-popup-content) {
    border-radius: 14px;
    padding: 0;
    overflow: hidden;
    min-width: 290px;
    box-shadow: 0 16px 34px rgba(15, 23, 42, 0.24);
  }

  :global(.map-popup) {
    background: #ffffff;
  }

  :global(.map-popup-body) {
    padding: 0.9rem 1rem 0.95rem;
  }

  :global(.map-popup-cover) {
    display: block;
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  :global(.map-popup-actions) {
    margin-top: 0.55rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  :global(.map-popup h3) {
    margin: 0;
    font-size: 1.02rem;
    font-family: "Manrope", sans-serif;
    line-height: 1.3;
  }

  :global(.map-popup p) {
    margin: 0.26rem 0 0;
    font-size: 0.9rem;
    color: rgba(32, 47, 78, 0.8);
    font-family: "Manrope", sans-serif;
    line-height: 1.35;
  }

  :global(.map-popup a) {
    display: inline-block;
    margin-top: 0;
    font-size: 0.9rem;
    font-weight: 700;
    color: #d32c43;
    text-decoration: none;
    font-family: "Manrope", sans-serif;
  }

  :global(.popup-start-route-btn) {
    margin-top: 0;
    border: 1px solid rgba(32, 47, 78, 0.16);
    background: #202f4e;
    color: #fff;
    border-radius: 999px;
    padding: 0.4rem 0.76rem;
    font-size: 0.86rem;
    font-weight: 700;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
  }

  :global(.mapboxgl-popup-close-button) {
    font-size: 1.05rem;
    padding: 0.38rem 0.52rem;
    line-height: 1;
    color: #0f172a;
  }

  .result-route-btn {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: fit-content;
    border: 1px solid transparent;
    background: linear-gradient(135deg, #202f4e, #253a61);
    color: #fff;
    border-radius: 999px;
    min-height: 30px;
    padding: 0.3rem 0.7rem;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
    transition: transform 0.16s ease, box-shadow 0.16s ease, opacity 0.16s ease;
  }

  .result-route-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 14px rgba(32, 47, 78, 0.26);
  }

  .result-actions {
    display: flex;
    gap: 0.38rem;
    align-items: center;
    margin-top: 0.18rem;
    flex-wrap: wrap;
    grid-column: 2;
  }

  .nav-results h3 {
    margin-top: 0.6rem;
  }

  .map-poi-overlay {
    position: absolute;
    top: 0.85rem;
    left: 0.85rem;
    z-index: 4;
    display: grid;
    gap: 0.45rem;
    padding: 0.62rem 0.72rem;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.38);
    background: linear-gradient(145deg, rgba(15, 23, 42, 0.52), rgba(30, 41, 59, 0.4));
    backdrop-filter: blur(4px);
    pointer-events: none;
  }

  .map-poi-overlay-title {
    margin: 0;
    color: #ffffff;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 900;
    text-shadow: 0 2px 7px rgba(0, 0, 0, 0.42);
    font-family: "Manrope", sans-serif;
  }

  .poi-filters-overlay {
    display: grid;
    gap: 0.38rem;
    justify-items: start;
    pointer-events: auto;
  }

  .poi-chip-overlay {
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    border: 0;
    background: rgba(15, 23, 42, 0.24);
    color: #ffffff;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.58);
    font-weight: 800;
    font-size: 0.96rem;
    padding: 0.2rem 0.32rem;
    border-radius: 999px;
  }

  .poi-chip-overlay .poi-chip-icon {
    width: 1.4rem;
    height: 1.4rem;
    text-align: center;
    font-size: 0.95rem;
    font-weight: 800;
    border-radius: 999px;
    line-height: 1.1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.95);
    background: rgba(15, 23, 42, 0.42);
  }

  .poi-chip-icon-svg {
    width: 0.92rem;
    height: 0.92rem;
    display: block;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.35));
  }

  .poi-chip-overlay[data-category="restaurant"] .poi-chip-icon { color: #fdba74; }
  .poi-chip-overlay[data-category="hospital"] .poi-chip-icon { color: #fda4af; }
  .poi-chip-overlay[data-category="school"] .poi-chip-icon { color: #93c5fd; }
  .poi-chip-overlay[data-category="pharmacy"] .poi-chip-icon { color: #86efac; }
  .poi-chip-overlay[data-category="leisure"] .poi-chip-icon { color: #d8b4fe; }

  .poi-chip-overlay.is-active {
    color: #ffffff;
    background: rgba(15, 23, 42, 0.58);
    box-shadow: 0 8px 16px rgba(2, 6, 23, 0.28);
  }

  /* Results are injected via innerHTML, so force global compact styles */
  :global(.map-result-list) {
    gap: 0.55rem;
    max-height: 460px;
  }

  :global(.map-result-item) {
    border: 1px solid rgba(32, 47, 78, 0.14);
    border-radius: 12px;
    padding: 0.56rem;
    display: grid;
    grid-template-columns: 84px minmax(0, 1fr);
    gap: 0.36rem 0.56rem;
    background: #fff;
    box-shadow: 0 5px 10px rgba(15, 23, 42, 0.06);
  }

  :global(.map-result-item.is-selected) {
    border-color: rgba(211, 44, 67, 0.45);
    box-shadow: 0 7px 12px rgba(211, 44, 67, 0.12);
  }

  :global(.result-media) {
    width: 84px;
    height: 84px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(32, 47, 78, 0.12);
    grid-row: span 2;
    background: #e6edf7;
  }

  :global(.result-media img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  :global(.result-body) {
    min-width: 0;
    display: grid;
    gap: 0.14rem;
  }

  :global(.result-jump) {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    border: 0;
    background: transparent;
    padding: 0;
    margin: 0;
    text-align: left;
    color: #202f4e;
    font-size: 0.94rem;
    font-weight: 800;
    line-height: 1.22;
    cursor: pointer;
    font-family: "Manrope", sans-serif;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  :global(.result-body > span:not(.map-result-tag)) {
    color: rgba(32, 47, 78, 0.76);
    font-size: 0.82rem;
    line-height: 1.2;
    font-family: "Manrope", sans-serif;
  }

  :global(.map-result-tag) {
    display: inline-flex;
    width: fit-content;
    border: 1px solid rgba(32, 47, 78, 0.15);
    border-radius: 999px;
    padding: 0.09rem 0.34rem;
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: #202f4e;
    background: rgba(32, 47, 78, 0.05);
  }

  :global(.result-actions) {
    display: flex;
    align-items: center;
    gap: 0.28rem;
    flex-wrap: wrap;
    grid-column: 2;
    margin-top: 0.1rem;
  }

  :global(.result-route-btn),
  :global(.result-open) {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    min-height: 30px;
    padding: 0.3rem 0.66rem;
    border-radius: 999px;
    font-size: 0.74rem;
    line-height: 1;
    font-weight: 700;
    font-family: "Manrope", sans-serif;
    text-decoration: none;
  }

  :global(.result-route-btn) {
    border: 1px solid transparent;
    background: #202f4e;
    color: #fff;
    cursor: pointer;
  }

  :global(.result-open) {
    border: 1px solid rgba(32, 47, 78, 0.15);
    background: #f8fafc;
    color: rgba(32, 47, 78, 0.55);
    pointer-events: none;
  }

  :global(.result-open.is-ready) {
    border-color: #1d4ed8;
    background: #1d4ed8;
    color: #fff;
    pointer-events: auto;
  }

  @media (max-width: 1080px) {
    .map-layout {
      grid-template-columns: 1fr;
      gap: 0.9rem;
    }

    .map-nav {
      position: static;
      top: auto;
      max-height: none;
      overflow: visible;
      padding-right: 0;
    }

    .map-result-list {
      max-height: none;
    }

    .map-result-item {
      grid-template-columns: 76px minmax(0, 1fr);
    }

    .result-media {
      width: 76px;
      height: 76px;
    }

    .map-poi-overlay {
      top: 0.65rem;
      left: 0.65rem;
    }

    .map-reset-wrap {
      top: 0.65rem;
      right: 3.9rem;
    }

    .map-route-overlay {
      top: 3.65rem;
      right: 0.65rem;
      width: min(310px, calc(100% - 1.3rem));
    }

    :global(.map-result-item) {
      grid-template-columns: 58px minmax(0, 1fr);
      padding: 0.42rem;
      gap: 0.28rem 0.42rem;
    }

    :global(.result-media) {
      width: 58px;
      height: 58px;
      border-radius: 8px;
    }

    :global(.result-jump) {
      font-size: 0.77rem;
    }

    :global(.result-body > span:not(.map-result-tag)) {
      font-size: 0.72rem;
    }

    :global(.map-result-tag) {
      font-size: 0.56rem;
    }

    :global(.result-route-btn),
    :global(.result-open) {
      min-height: 24px;
      padding: 0.18rem 0.5rem;
      font-size: 0.64rem;
    }
  }

  @media (max-width: 760px) {
    .costa-map {
      min-height: 420px;
      height: 64vh;
    }

    .map-layout {
      padding-bottom: 1.6rem;
    }

    .map-result-item {
      grid-template-columns: 1fr;
    }

    .result-media {
      width: 100%;
      height: 132px;
      grid-row: auto;
    }

    .result-actions {
      grid-column: auto;
    }

    :global(.map-result-item) {
      grid-template-columns: 1fr;
    }

    :global(.result-media) {
      width: 100%;
      height: 92px;
      grid-row: auto;
    }

    :global(.result-actions) {
      grid-column: auto;
    }

    .map-nav {
      display: none;
    }

    .map-poi-overlay {
      top: 0.55rem;
      left: 0.55rem;
      right: 0.55rem;
      bottom: auto;
      justify-items: start;
      padding: 0.5rem 0.55rem;
    }

    .poi-filters-overlay {
      justify-items: start;
      display: flex;
      flex-wrap: wrap;
      gap: 0.28rem;
    }

    .poi-chip-overlay {
      font-size: 0.78rem;
      padding: 0.14rem 0.28rem;
      gap: 0.35rem;
    }

    .poi-chip-overlay .poi-chip-icon {
      width: 1.1rem;
      height: 1.1rem;
      border-width: 1.5px;
    }

    .map-reset-wrap {
      left: 0.55rem;
      right: auto;
      top: 5.65rem;
    }

    .map-reset-view-btn {
      font-size: 0.64rem;
      padding: 0.42rem 0.7rem;
    }

    .map-route-overlay {
      top: auto;
      left: 0.55rem;
      right: 0.55rem;
      bottom: 0.55rem;
      width: auto;
      border-radius: 16px;
      border-color: rgba(255, 255, 255, 0.36);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.78), rgba(30, 41, 59, 0.72));
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.3);
    }
  }
</style>

